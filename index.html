<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="„Çø„Çπ„ÇØÁÆ°ÁêÜ">
    <meta name="theme-color" content="#f49097">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23f49097' width='100' height='100' rx='20'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-size='50'>üìã</text></svg>">
    <title>„Çø„Çπ„ÇØÁÆ°ÁêÜ</title>

    <style>
        :root {
            --color-primary: #f49097;
            --color-secondary: #dfb2f4;
            --color-accent: #55d6c2;
            --color-highlight: #f5e960;
            --color-bg: #f2f5ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, var(--color-bg) 0%, #ffffff 100%);
            color: #333;
        }

        .app { display: flex; flex-direction: column; height: 100dvh; }

        /* „É°„Ç§„É≥„Çø„Éñ */
        .main-tabs {
            display: flex;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .main-tab {
            flex: 1;
            padding: 14px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }

        .main-tab.active { color: var(--color-primary); }
        .main-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            right: 20%;
            height: 3px;
            background: var(--color-primary);
            border-radius: 3px 3px 0 0;
        }

        .main-tab:nth-child(2).active { color: var(--color-accent); }
        .main-tab:nth-child(2).active::after { background: var(--color-accent); }

        .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }

        /* ===== TODO ===== */
        .todo-header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .todo-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .sync-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: #e5e7eb;
            color: #666;
        }

        .sync-badge.syncing { background: #fef3c7; color: #92400e; }
        .sync-badge.success { background: #d1fae5; color: #065f46; }
        .sync-badge.error { background: #fee2e2; color: #991b1b; }

        .task-count {
            font-size: 11px;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 12px;
            color: #666;
            margin-left: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn.theme { background: rgba(223,178,244,0.2); color: var(--color-secondary); }
        .icon-btn.add-col { border: 2px dashed #d1d5db; background: transparent; color: #9ca3af; }

        .pc-input { display: none; gap: 10px; }
        @media (min-width: 640px) { .pc-input { display: flex; } }

        .task-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
        }

        .task-input:focus { border-color: var(--color-primary); }

        .add-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            color: white;
            background: var(--color-primary);
            cursor: pointer;
        }

        .add-btn:disabled { opacity: 0.4; }
        .add-btn.ready { background: var(--color-accent); }

        /* „Ç´„É≥„Éê„É≥ */
        .kanban {
            flex: 1;
            display: flex;
            gap: 16px;
            padding: 16px;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .column {
            flex-shrink: 0;
            width: 280px;
            background: white;
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            max-height: 100%;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
        }

        @media (min-width: 640px) { .column { width: 320px; } }

        .column.drag-over { 
            box-shadow: 0 0 0 3px var(--color-accent), 0 8px 24px rgba(85, 214, 194, 0.3); 
            background: rgba(85, 214, 194, 0.08);
            transform: scale(1.02);
        }

        .column-header {
            padding: 12px 14px;
            border-radius: 14px 14px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .column-title { font-weight: 600; font-size: 14px; }
        .column-count { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: rgba(255,255,255,0.25); margin-left: 8px; }

        .column-delete {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 6px;
            background: rgba(255,255,255,0.2);
            cursor: pointer;
            opacity: 0.7;
        }

        .task-list { flex: 1; padding: 10px; overflow-y: auto; min-height: 150px; transition: background 0.2s; }
        .column.drag-over .task-list { background: rgba(85, 214, 194, 0.05); }

        .task-card {
            background: white;
            border: 2px solid #f3f4f6;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: grab;
            position: relative;
            transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
        }

        .task-card:active { cursor: grabbing; }

        .task-card.important { border-color: var(--color-primary); background: linear-gradient(135deg, rgba(244,144,151,0.08), white); }
        .task-card.dragging { 
            opacity: 0.9; 
            transform: rotate(4deg) scale(1.05); 
            box-shadow: 0 12px 28px rgba(0,0,0,0.2);
            z-index: 100;
        }
        .task-card.drag-over-top {
            border-top: 3px solid var(--color-accent);
            margin-top: -1px;
        }
        .task-card.drag-over-bottom {
            border-bottom: 3px solid var(--color-accent);
            margin-bottom: -1px;
        }
        .task-card.done-task { opacity: 0.6; }
        .task-card.done-task .task-title { text-decoration: line-through; color: #9ca3af; }

        .days-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            font-size: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .task-title { font-size: 13px; font-weight: 500; line-height: 1.4; padding-right: 20px; }
        .task-meta { display: flex; gap: 4px; margin-top: 8px; color: #9ca3af; font-size: 11px; }

        .task-actions { display: flex; gap: 2px; margin-top: 4px; padding-top: 4px; border-top: 1px solid #f3f4f6; align-items: center; }

        .task-move-btns { display: flex; gap: 2px; }

        .task-move-btn {
            width: 28px;
            height: 24px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            color: #666;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-move-btn:hover:not(:disabled) { background: var(--color-accent); color: white; border-color: var(--color-accent); }
        .task-move-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .task-action-btn {
            width: 24px;
            height: 20px;
            border: none;
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            color: #d1d5db;
            font-size: 11px;
        }

        .task-action-btn.star-btn.active { color: var(--color-primary); background: rgba(244,144,151,0.15); }
        .task-action-btn.complete-btn { margin-left: auto; }
        .task-action-btn.complete-btn:hover { color: white; background: var(--color-accent); }

        /* „Çπ„Éû„Éõ„Åß„ÅØ‚òÖ‚úì„ÇíÈùûË°®Á§∫ */
        @media (max-width: 639px) {
            .task-action-btn.pc-only { display: none; }
        }

        .empty-column { display: flex; flex-direction: column; align-items: center; padding: 40px 20px; color: #d1d5db; }
        .empty-icon { width: 48px; height: 48px; border-radius: 50%; background: #f9fafb; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }

        .mobile-input { background: rgba(255,255,255,0.95); border-top: 1px solid #e5e7eb; }
        @media (min-width: 640px) { .mobile-input { display: none; } }

        .mobile-input-collapsed {
            padding: 14px 16px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-primary);
            cursor: pointer;
        }

        .mobile-input-collapsed:active { background: #f9fafb; }

        .mobile-input-expanded {
            padding: 12px;
        }

        .mobile-input-expanded.hidden { display: none; }

        .mobile-input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .mobile-input-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .mobile-input-close {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: #f3f4f6;
            font-size: 14px;
            cursor: pointer;
            color: #666;
        }

        .mobile-col-tabs {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .mobile-col-tab {
            flex-shrink: 0;
            padding: 8px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: white;
            color: #666;
            cursor: pointer;
            transition: all 0.15s;
        }

        .mobile-col-tab.active {
            border-color: var(--color-primary);
            background: var(--color-primary);
            color: white;
        }

        .mobile-input-row {
            display: flex;
            gap: 8px;
        }

        .mobile-input-row .task-input { flex: 1; padding: 12px 14px; }

        /* ===== ÁøíÊÖ£„Éà„É©„ÉÉ„Ç´„Éº ===== */
        .habit-header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
        }

        .habit-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        .habit-btn.today { background: #f3f4f6; color: #666; }
        .habit-btn.stats { background: rgba(85,214,194,0.2); color: var(--color-accent); }
        .habit-btn.add { background: var(--color-accent); color: white; }
        .habit-btn.more { background: #f3f4f6; color: #666; }

        .habit-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            margin: 12px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .habit-table-head {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            background: #fafafa;
        }

        .habit-date-col { flex-shrink: 0; width: 88px; padding: 10px 8px; font-size: 11px; font-weight: 600; color: #666; border-right: 1px solid #e5e7eb; }
        @media (min-width: 640px) { .habit-date-col { width: 110px; } }

        .habit-score-col-head {
            flex-shrink: 0;
            width: 70px;
            padding: 10px 4px;
            font-size: 10px;
            font-weight: 600;
            color: #666;
            border-right: 1px solid #e5e7eb;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .habit-daily-scores {
            flex-shrink: 0;
            width: 70px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 4px;
            border-right: 1px solid #e5e7eb;
            align-items: center;
            justify-content: center;
        }

        .daily-score {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 58px;
            height: 18px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            color: #333;
        }

        .daily-score.day::before { content: '‚òÄ'; font-size: 8px; margin-right: 2px; }
        .daily-score.night::before { content: 'üåô'; font-size: 7px; margin-right: 2px; }

        .habit-items-head { flex: 1; display: flex; overflow-x: hidden; }

        .habit-item-col { flex-shrink: 0; width: 52px; padding: 8px 4px; text-align: center; border-right: 1px solid #f3f4f6; cursor: grab; user-select: none; transition: transform 0.15s, background 0.15s; }
        .habit-item-col:last-child { border-right: none; }
        .habit-item-col:active { cursor: grabbing; }
        .habit-item-col.dragging { opacity: 0.5; background: #e5e7eb; transform: scale(0.95); }
        .habit-item-col.drag-over { background: rgba(85,214,194,0.3); transform: scale(1.05); }
        .habit-emoji { font-size: 18px; pointer-events: none; }
        .habit-name { font-size: 9px; color: #666; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none; }

        .habit-table-body { flex: 1; overflow-y: auto; }

        .habit-month-div {
            position: sticky;
            top: 0;
            z-index: 5;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 700;
            border-bottom: 2px solid var(--color-primary);
        }

        .month-bg-1 { background: linear-gradient(90deg, #fef2f2, white); }
        .month-bg-2 { background: linear-gradient(90deg, #fdf2f8, white); }
        .month-bg-3 { background: linear-gradient(90deg, #faf5ff, white); }
        .month-bg-4 { background: linear-gradient(90deg, #f0fdf4, white); }
        .month-bg-5 { background: linear-gradient(90deg, #ecfdf5, white); }
        .month-bg-6 { background: linear-gradient(90deg, #f0fdfa, white); }
        .month-bg-7 { background: linear-gradient(90deg, #ecfeff, white); }
        .month-bg-8 { background: linear-gradient(90deg, #f0f9ff, white); }
        .month-bg-9 { background: linear-gradient(90deg, #eff6ff, white); }
        .month-bg-10 { background: linear-gradient(90deg, #fefce8, white); }
        .month-bg-11 { background: linear-gradient(90deg, #fff7ed, white); }
        .month-bg-12 { background: linear-gradient(90deg, #fef2f2, white); }

        .habit-row { display: flex; border-bottom: 1px solid #f3f4f6; }
        .habit-row:hover { background: #fafafa; }
        .habit-row.today { background: #fefce8; }
        .habit-row.weekend { background: rgba(254,202,202,0.15); }

        .habit-date-cell {
            flex-shrink: 0;
            width: 88px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            border-right: 1px solid #e5e7eb;
            font-size: 13px;
        }

        @media (min-width: 640px) { .habit-date-cell { width: 110px; } }

        .day-name { font-size: 10px; padding: 2px 4px; border-radius: 4px; color: #666; }
        .habit-row.weekend .day-name { color: #ef4444; }
        .date-num { font-weight: 500; color: #333; }
        .habit-row.today .date-num { color: #ca8a04; font-weight: 700; }
        .today-badge { font-size: 9px; background: #fbbf24; color: #78350f; padding: 1px 5px; border-radius: 8px; font-weight: 600; margin-left: auto; }

        .habit-scores-cell { flex: 1; display: flex; overflow-x: auto; scroll-behavior: auto; -webkit-overflow-scrolling: touch; }
        .habit-scores-cell::-webkit-scrollbar { display: none; }

        .habit-score-cell { flex-shrink: 0; width: 52px; padding: 6px 4px; display: flex; align-items: center; justify-content: center; border-right: 1px solid #f3f4f6; }
        .habit-score-cell:last-child { border-right: none; }

        /* Ë°®Á§∫Â∞ÇÁî®„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éû„Éº„ÇØ */
        .check-display {
            width: 36px;
            height: 36px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            background: white;
            color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .check-display.done { 
            background: var(--color-accent); 
            border-color: var(--color-accent); 
            color: white; 
        }

        .check-btn {
            width: 36px;
            height: 36px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            background: white;
            color: transparent;
            transition: all 0.15s;
        }

        .check-btn:hover { border-color: var(--color-accent); transform: scale(1.1); }
        .check-btn.done { 
            background: var(--color-accent); 
            border-color: var(--color-accent); 
            color: white; 
        }

        .score-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
        }

        .score-btn:hover { transform: scale(1.1); }

        /* ÁøíÊÖ£„ÉÜ„Éº„Éñ„É´„ÅÆ„Éò„ÉÉ„ÉÄ„Éº„Çπ„ÇØ„É≠„Éº„É´ */
        .habit-items-head { flex: 1; display: flex; overflow-x: auto; scroll-behavior: auto; -webkit-overflow-scrolling: touch; }
        .habit-items-head::-webkit-scrollbar { display: none; }

        /* ÁøíÊÖ£„ÅåÁÑ°„ÅÑÊôÇ */
        .habit-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            padding: 40px;
        }

        .habit-empty-icon { font-size: 48px; margin-bottom: 12px; }
        .habit-empty-text { font-size: 14px; margin-bottom: 16px; }

        /* ===== „É¢„Éº„ÉÄ„É´ ===== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        @media (min-width: 640px) { .modal-overlay { align-items: center; padding: 20px; } }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: white;
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            transform: translateY(100%);
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 640px) { .modal { border-radius: 20px; max-width: 480px; transform: translateY(20px) scale(0.95); } }

        .modal-overlay.active .modal { transform: translateY(0) scale(1); }

        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid #f3f4f6; }
        .modal-title { font-size: 17px; font-weight: 600; }
        .modal-close { width: 32px; height: 32px; border: none; border-radius: 8px; background: #f3f4f6; cursor: pointer; color: #9ca3af; }

        .modal-body { padding: 16px 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid #f3f4f6; }

        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: #666; margin-bottom: 6px; }
        .form-input { width: 100%; padding: 12px 14px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; outline: none; }
        .form-input:focus { border-color: var(--color-primary); }

        .btn-full { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--color-primary); color: white; }
        .btn-accent { background: var(--color-accent); color: white; }
        .btn-secondary { background: #f3f4f6; color: #666; }
        .btn-danger { background: white; color: #ef4444; border: 2px solid #fecaca; }
        .btn-row { display: flex; gap: 12px; }
        .btn-row .btn-full { flex: 1; }

        .emoji-grid { display: flex; gap: 8px; flex-wrap: wrap; }
        .emoji-btn { width: 44px; height: 44px; border: 2px solid transparent; border-radius: 10px; background: #f3f4f6; font-size: 22px; cursor: pointer; }
        .emoji-btn.selected { border-color: var(--color-secondary); background: rgba(223,178,244,0.2); }

        .score-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .score-option { aspect-ratio: 1; border: none; border-radius: 12px; font-size: 20px; font-weight: 700; cursor: pointer; }
        .score-option:hover { transform: scale(1.05); }
        .score-option.selected { box-shadow: 0 0 0 3px var(--color-primary); }

        /* Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞ */
        .confirm-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1500; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .confirm-backdrop.active { opacity: 1; visibility: visible; }
        .confirm-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: white; border-radius: 16px; padding: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); z-index: 1600; min-width: 280px; text-align: center; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .confirm-dialog.active { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }
        .confirm-dialog h3 { font-size: 16px; margin-bottom: 8px; }
        .confirm-dialog p { font-size: 14px; color: #666; margin-bottom: 20px; }
        .confirm-btns { display: flex; gap: 12px; }
        .cancel-btn, .confirm-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .cancel-btn { background: #f3f4f6; color: #666; }
        .confirm-btn { background: var(--color-primary); color: white; }
        .confirm-btn.complete { background: var(--color-accent); }
        .confirm-btn.danger { background: #ef4444; }

        /* Áµ±Ë®à */
        .stats-tabs { display: flex; gap: 4px; padding: 4px; background: #f3f4f6; border-radius: 10px; margin-bottom: 16px; }
        .stats-tab { flex: 1; padding: 8px 6px; border: none; border-radius: 8px; background: transparent; font-size: 11px; font-weight: 500; color: #666; cursor: pointer; white-space: nowrap; }
        .stats-tab.active { background: white; color: var(--color-primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .stats-section-title { font-size: 13px; font-weight: 600; color: #666; margin: 16px 0 12px; }

        /* „Çπ„Éà„É™„Éº„ÇØ„Éê„Éä„Éº */
        .streak-banner { display: flex; align-items: center; gap: 12px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .streak-emoji { font-size: 40px; }
        .streak-info { flex: 1; }
        .streak-label { font-size: 12px; color: #92400e; }
        .streak-value { font-size: 32px; font-weight: 700; color: #78350f; }
        .streak-value span { font-size: 16px; color: #a16207; }

        /* ÈÄ±Èñì„Çµ„Éû„É™„Éº */
        .week-summary { display: flex; gap: 8px; margin-bottom: 16px; }
        .week-score-card { flex: 1; background: #f9fafb; border-radius: 12px; padding: 12px; text-align: center; }
        .week-score-label { font-size: 11px; color: #666; margin-bottom: 6px; }
        .week-score-value { font-size: 28px; font-weight: 700; color: #333; }
        .week-score-value span { font-size: 14px; color: #999; }
        .week-score-bar { height: 6px; background: #e5e7eb; border-radius: 3px; margin: 8px 0; overflow: hidden; }
        .week-score-fill { height: 100%; border-radius: 3px; }
        .week-score-goal { font-size: 10px; color: #666; }
        .week-score-goal.achieved { color: #059669; font-weight: 600; }

        /* ‰ªäÈÄ±„ÅÆÊó•Âà•„ÉÅ„É£„Éº„Éà */
        .week-chart { display: flex; gap: 4px; height: 100px; padding: 8px; background: #fafafa; border-radius: 12px; margin-bottom: 16px; }
        .week-chart-day { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .week-chart-day.today { background: rgba(251,191,36,0.1); border-radius: 8px; }
        .week-chart-bars { flex: 1; display: flex; gap: 2px; align-items: flex-end; width: 100%; }
        .week-chart-bar { flex: 1; min-height: 2px; border-radius: 2px 2px 0 0; }
        .week-chart-label { font-size: 10px; color: #666; margin-top: 4px; }
        .week-chart-day.today .week-chart-label { font-weight: 700; color: #ca8a04; }

        /* ÁøíÊÖ£ÈÅîÊàêË°å */
        .habit-stat-row { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid #f3f4f6; }
        .habit-stat-row:last-child { border-bottom: none; }
        .habit-stat-emoji { font-size: 20px; flex-shrink: 0; }
        .habit-stat-content { flex: 1; min-width: 0; }
        .habit-stat-name-row { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 13px; font-weight: 500; }
        .habit-streak-badge { font-size: 10px; background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 10px; }
        .habit-stat-pct { font-size: 16px; font-weight: 700; color: var(--color-primary); flex-shrink: 0; }
        .habit-stat-detail { font-size: 10px; color: #999; text-align: right; flex-shrink: 0; }

        /* ÊúàÈñì„Çµ„Éû„É™„Éº */
        .month-summary { display: flex; gap: 12px; margin-bottom: 16px; }
        .month-score-item { flex: 1; text-align: center; }
        .month-score-label { font-size: 11px; color: #666; margin-bottom: 6px; }
        .month-score-value { display: inline-flex; align-items: center; justify-content: center; width: 56px; height: 56px; border-radius: 50%; font-size: 24px; font-weight: 700; color: #333; }
        .month-score-sub { font-size: 10px; color: #999; margin-top: 4px; }

        /* ÈÄ±ÈñìÊé®Áßª„ÉÅ„É£„Éº„Éà */
        .weeks-chart { display: flex; gap: 8px; height: 120px; padding: 8px; background: #fafafa; border-radius: 12px; margin-bottom: 8px; }
        .weeks-chart-item { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .weeks-chart-bars { flex: 1; display: flex; gap: 3px; align-items: flex-end; width: 100%; }
        .weeks-bar { flex: 1; min-height: 4px; border-radius: 3px 3px 0 0; display: flex; align-items: flex-start; justify-content: center; }
        .weeks-bar span { font-size: 9px; font-weight: 600; color: #333; margin-top: 2px; }
        .weeks-chart-label { font-size: 10px; color: #666; margin-top: 4px; }

        .chart-legend { display: flex; justify-content: center; gap: 16px; margin-bottom: 16px; }
        .legend-item { display: flex; align-items: center; gap: 4px; font-size: 11px; color: #666; }
        .legend-dot { width: 10px; height: 10px; border-radius: 2px; }
        .legend-dot.day { background: #fef08a; }
        .legend-dot.night { background: #c4b5fd; }

        /* ÊúàÈñìÊé®Áßª„ÉÅ„É£„Éº„Éà */
        .months-chart { display: flex; gap: 4px; height: 100px; padding: 8px; background: #fafafa; border-radius: 12px; margin-bottom: 16px; }
        .months-chart-item { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .months-chart-bars { flex: 1; display: flex; gap: 2px; align-items: flex-end; width: 100%; }
        .months-bar { flex: 1; min-height: 2px; border-radius: 2px 2px 0 0; }
        .months-chart-values { display: flex; gap: 2px; font-size: 8px; margin-top: 2px; }
        .months-chart-values .day-val { color: #ca8a04; }
        .months-chart-values .night-val { color: #7c3aed; }
        .months-chart-label { font-size: 9px; color: #666; }

        /* ÁõÆÊ®ôË®≠ÂÆö */
        .goal-setting { background: #f9fafb; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .goal-desc { font-size: 12px; color: #666; margin-bottom: 16px; }
        .goal-input-group { margin-bottom: 16px; }
        .goal-label { font-size: 13px; font-weight: 500; color: #333; margin-bottom: 8px; display: block; }
        .goal-input-row { display: flex; align-items: center; gap: 12px; }
        .goal-input-row input[type="range"] { flex: 1; height: 6px; -webkit-appearance: none; background: #e5e7eb; border-radius: 3px; }
        .goal-input-row input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--color-primary); border-radius: 50%; cursor: pointer; }
        .goal-value { font-size: 20px; font-weight: 700; color: var(--color-primary); min-width: 36px; text-align: right; }

        /* „Éê„ÉÉ„Ç∏ */
        .badges-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .badge-item { position: relative; background: #f3f4f6; border-radius: 12px; padding: 12px 8px; text-align: center; opacity: 0.4; }
        .badge-item.earned { opacity: 1; background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .badge-icon { font-size: 28px; }
        .badge-name { font-size: 10px; color: #666; margin-top: 4px; }
        .badge-check { position: absolute; top: 4px; right: 4px; width: 16px; height: 16px; background: #059669; color: white; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; }

        .summary-card { background: linear-gradient(135deg, rgba(244,144,151,0.1), rgba(223,178,244,0.1)); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
        .summary-label { font-size: 12px; color: #666; margin-bottom: 4px; }
        .summary-value { font-size: 36px; font-weight: 700; color: var(--color-primary); }
        .summary-value span { font-size: 20px; color: #999; }
        .summary-bar { height: 8px; background: white; border-radius: 4px; margin-top: 12px; overflow: hidden; }
        .summary-bar-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, var(--color-primary), var(--color-secondary)); }

        .bar-chart { display: flex; align-items: flex-end; justify-content: space-between; gap: 6px; height: 120px; padding: 8px; background: #fafafa; border-radius: 12px; }
        .bar-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .bar-value { font-size: 10px; font-weight: 600; color: var(--color-primary); }
        .bar-fill { width: 100%; border-radius: 4px 4px 0 0; background: linear-gradient(180deg, var(--color-primary), var(--color-secondary)); }
        .bar-label { font-size: 10px; color: #666; }

        .habit-stat-card { background: #f9fafb; border-radius: 12px; padding: 12px; margin-bottom: 8px; }
        .habit-stat-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .habit-stat-name { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500; }
        .habit-stat-name span:first-child { font-size: 18px; }
        .habit-stat-bar { height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
        .habit-stat-bar-fill { height: 100%; border-radius: 3px; }
        .habit-stat-meta { display: flex; justify-content: space-between; font-size: 11px; color: #999; margin-top: 6px; }

        .month-selector { display: flex; align-items: center; justify-content: space-between; background: #f3f4f6; border-radius: 12px; padding: 8px; margin-bottom: 16px; }
        .month-nav { width: 36px; height: 36px; border: none; border-radius: 8px; background: white; cursor: pointer; font-size: 18px; color: #666; }
        .month-label { font-size: 15px; font-weight: 600; color: #333; }

        /* ÁøíÊÖ£ÁÆ°ÁêÜ„É™„Çπ„Éà */
        .habit-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
        }

        .habit-list-item:last-child { border-bottom: none; }

        .habit-list-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .habit-list-emoji { font-size: 24px; }
        .habit-list-name { font-size: 14px; font-weight: 500; }

        .habit-list-del {
            padding: 8px 12px;
            border: 2px solid #fecaca;
            border-radius: 8px;
            background: white;
            color: #ef4444;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        .habit-list-del:hover { background: #fef2f2; }

        /* „Ç´„É©„É†‰∏¶„Å≥Êõø„Åà„É™„Çπ„Éà */
        .column-order-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 8px;
            background: #f9fafb;
            border-radius: 10px;
            cursor: grab;
            user-select: none;
            transition: transform 0.15s, background 0.15s, box-shadow 0.15s;
        }

        .column-order-item:active { cursor: grabbing; }
        .column-order-item.dragging { opacity: 0.5; transform: scale(0.98); }
        .column-order-item.drag-over { background: rgba(85,214,194,0.2); box-shadow: 0 0 0 2px var(--color-accent); }

        .column-order-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .column-order-color {
            width: 24px;
            height: 24px;
            border-radius: 6px;
        }

        .column-order-name { font-size: 14px; font-weight: 500; }
        .column-order-count { font-size: 12px; color: #9ca3af; }

        .column-order-handle {
            color: #d1d5db;
            font-size: 18px;
            padding: 4px 8px;
        }

        .column-order-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-order-arrows {
            display: flex;
            gap: 4px;
        }

        .column-order-arrows button {
            width: 32px;
            height: 32px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            color: #666;
        }

        .column-order-arrows button:hover { background: #f3f4f6; }
        .column-order-arrows button:disabled { opacity: 0.3; cursor: not-allowed; }

        .column-order-del {
            width: 32px;
            height: 32px;
            border: 1px solid #fecaca;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            color: #ef4444;
        }

        .column-order-del:hover { background: #fef2f2; }
        .column-order-del:disabled { opacity: 0.3; cursor: not-allowed; border-color: #e5e7eb; color: #d1d5db; }

        .column-order-default { 
            font-size: 10px; 
            color: #9ca3af; 
            background: #f3f4f6; 
            padding: 2px 6px; 
            border-radius: 4px; 
            margin-left: 6px; 
        }

        /* Êó•Ë®ò„É¢„Éº„ÉÄ„É´ */
        .diary-modal { max-width: 90vw; width: 600px; }
        
        .diary-date-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px 16px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .diary-nav-btn {
            width: 36px;
            height: 36px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            color: #666;
        }

        .diary-nav-btn:hover { background: #f3f4f6; }

        .diary-date {
            font-size: 16px;
            font-weight: 600;
            min-width: 140px;
            text-align: center;
        }

        .diary-today-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            background: var(--color-accent);
            color: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        .diary-scores-row {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(244,144,151,0.1), rgba(223,178,244,0.1));
            border-bottom: 1px solid #e5e7eb;
        }

        .diary-score-block {
            flex: 1;
            text-align: center;
        }

        .diary-score-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            display: block;
        }

        .diary-score-input-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .diary-score-btn {
            width: 36px;
            height: 36px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            color: #666;
        }

        .diary-score-btn:hover { background: #f3f4f6; }
        .diary-score-btn.minus { color: var(--color-primary); }
        .diary-score-btn.plus { color: var(--color-accent); }

        .diary-score-input {
            width: 60px;
            height: 40px;
            border: 2px solid var(--color-primary);
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            color: var(--color-primary);
        }

        .diary-score-input:focus { outline: none; border-color: var(--color-accent); }

        .diary-total-score {
            padding: 16px;
            background: linear-gradient(135deg, rgba(244,144,151,0.1), rgba(223,178,244,0.1));
            border-bottom: 1px solid #e5e7eb;
            text-align: center;
        }

        .diary-total-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }

        .diary-total-input-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .diary-total-btn {
            width: 44px;
            height: 44px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            color: #666;
        }

        .diary-total-btn:hover { background: #f3f4f6; }
        .diary-total-btn.minus { color: var(--color-primary); }
        .diary-total-btn.plus { color: var(--color-accent); }

        .diary-total-input {
            width: 80px;
            height: 50px;
            border: 2px solid var(--color-primary);
            border-radius: 12px;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            color: var(--color-primary);
        }

        .diary-total-input:focus { outline: none; border-color: var(--color-accent); }

        .diary-habit-tabs {
            display: flex;
            gap: 6px;
            padding: 12px;
            overflow-x: auto;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .diary-habit-tab {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.15s;
            min-width: 60px;
        }

        .diary-habit-tab:hover { border-color: #d1d5db; }
        .diary-habit-tab.active { border-color: var(--color-primary); background: rgba(244,144,151,0.1); }
        .diary-habit-tab.has-note { border-color: var(--color-accent); }
        .diary-habit-tab.active.has-note { border-color: var(--color-primary); }

        .diary-tab-emoji { font-size: 20px; }
        .diary-tab-name { font-size: 10px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 50px; }
        .diary-tab-badge { 
            font-size: 10px; 
            padding: 1px 6px;
            border-radius: 8px;
            background: #f3f4f6;
            color: #9ca3af;
        }
        .diary-habit-tab.has-note .diary-tab-badge { background: var(--color-accent); color: white; }

        .diary-input-area {
            padding: 20px 16px;
        }

        .diary-current-habit {
            text-align: center;
            margin-bottom: 16px;
        }

        .diary-current-emoji { font-size: 40px; }
        .diary-current-name { font-size: 18px; font-weight: 600; margin-top: 8px; }

        .diary-note-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            resize: none;
            min-height: 120px;
        }

        .diary-note-input:focus { outline: none; border-color: var(--color-primary); }

        .diary-note-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }

        .diary-nav-arrows {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .diary-arrow-btn {
            flex: 1;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            color: #666;
        }

        .diary-arrow-btn:hover { background: #f3f4f6; }

        .habit-btn.diary { background: rgba(245,233,96,0.2); color: #92400e; }

        .hidden { display: none !important; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 12px; }
        .loading-overlay.hidden { display: none; }
        .loading-box { background: rgba(0,0,0,0.8); color: white; padding: 16px 24px; border-radius: 12px; display: flex; align-items: center; gap: 12px; }
        .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="app">
        <div class="loading-overlay hidden" id="loading"><div class="loading-box"><div class="spinner"></div><span id="loadingText">Ë™≠Ëæº‰∏≠...</span></div></div>

        <div class="main-tabs">
            <button class="main-tab active" onclick="switchTab('todo')">üìã TODO</button>
            <button class="main-tab" onclick="switchTab('habit')">üìä ÁøíÊÖ£</button>
        </div>

        <!-- TODO -->
        <div class="tab-content active" id="todoTab">
            <div class="todo-header">
                <div class="todo-header-row">
                    <div style="display:flex;align-items:center;">
                        <span class="sync-badge" id="syncBadge">„É≠„Éº„Ç´„É´</span>
                        <span class="task-count" id="taskCount">0‰ª∂</span>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="icon-btn theme" onclick="openThemeModal()" title="„ÉÜ„Éº„Éû">üé®</button>
                        <button class="icon-btn theme" onclick="openColumnOrderModal()" title="„Ç´„É©„É†‰∏¶„Å≥Êõø„Åà">‚ÜîÔ∏è</button>
                        <button class="icon-btn add-col" onclick="openColumnModal()" title="„Ç´„É©„É†ËøΩÂä†">+</button>
                    </div>
                </div>
                <div class="pc-input">
                    <input type="text" class="task-input" id="pcInput" placeholder="Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ...">
                    <button class="add-btn" id="pcBtn" onclick="addTask('pc')" disabled>ËøΩÂä†</button>
                </div>
            </div>
            <div class="kanban" id="kanban"></div>
            <div class="mobile-input">
                <div class="mobile-input-collapsed" id="mobileInputCollapsed" onclick="expandMobileInput()">
                    <span>Ôºã „Çø„Çπ„ÇØ„ÇíËøΩÂä†</span>
                </div>
                <div class="mobile-input-expanded hidden" id="mobileInputExpanded">
                    <div class="mobile-input-header">
                        <span class="mobile-input-title">„Çø„Çπ„ÇØ„ÇíËøΩÂä†</span>
                        <button class="mobile-input-close" onclick="collapseMobileInput()">‚úï</button>
                    </div>
                    <div class="mobile-col-tabs" id="mobileColTabs"></div>
                    <div class="mobile-input-row">
                        <input type="text" class="task-input" id="mobileInput" placeholder="Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ...">
                        <button class="add-btn" id="mobileBtn" onclick="addTask('mobile')" disabled>ËøΩÂä†</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÁøíÊÖ£ -->
        <div class="tab-content" id="habitTab">
            <div class="habit-header">
                <button class="habit-btn today" onclick="scrollToToday()">üìÖ ‰ªäÊó•</button>
                <div style="display:flex;gap:8px;">
                    <button class="habit-btn diary" onclick="openDiaryModal()">üìù Êó•Ë®ò</button>
                    <button class="habit-btn stats" onclick="openStatsModal()">üìà ÈõÜË®à</button>
                    <button class="habit-btn add" onclick="openHabitModal()">+ ÁøíÊÖ£</button>
                    <button class="habit-btn more" onclick="openHabitManageModal()">‚öôÔ∏è</button>
                </div>
            </div>
            <div class="habit-container" id="habitContainer"></div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="memoModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="memoTitle">„Çø„Çπ„ÇØË©≥Á¥∞</span>
                <button class="modal-close" onclick="closeMemoModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">„Çø„Ç§„Éà„É´</label>
                    <div style="display:flex;gap:8px;">
                        <input type="text" class="form-input" id="titleInput" style="flex:1;">
                        <button class="add-btn" onclick="saveTitle()">‰øùÂ≠ò</button>
                    </div>
                </div>
                <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid #f3f4f6;margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span style="font-size:14px;">ÈáçË¶Å</span>
                        <button id="importantBtn" onclick="toggleImportant()" style="width:44px;height:26px;border:none;border-radius:13px;background:#e5e7eb;cursor:pointer;position:relative;">
                            <span id="importantKnob" style="position:absolute;top:3px;left:3px;width:20px;height:20px;background:white;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,0.2);transition:transform 0.2s;"></span>
                        </button>
                    </div>
                    <button onclick="confirmDelete()" style="width:36px;height:36px;border:2px solid #fecaca;border-radius:10px;background:white;cursor:pointer;">üóëÔ∏è</button>
                </div>
                <div class="form-group">
                    <label class="form-label">„É°„É¢</label>
                    <div style="display:flex;gap:8px;">
                        <input type="text" class="form-input" id="memoInput" placeholder="„É°„É¢„ÇíËøΩÂä†..." style="flex:1;">
                        <button class="add-btn" onclick="addMemo()">ËøΩÂä†</button>
                    </div>
                </div>
                <div id="memoList"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="columnModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Êñ∞„Åó„ÅÑ„Ç´„É©„É†</span>
                <button class="modal-close" onclick="closeColumnModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">„Ç´„É©„É†Âêç</label>
                    <input type="text" class="form-input" id="colNameInput" placeholder="‰æã: „É¨„Éì„É•„ÉºÂæÖ„Å°">
                </div>
                <div class="form-group">
                    <label class="form-label">„Ç´„É©„Éº</label>
                    <div id="colColorPicker" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="btn-row">
                    <button class="btn-full btn-secondary" onclick="closeColumnModal()">„Ç≠„É£„É≥„Çª„É´</button>
                    <button class="btn-full btn-primary" onclick="addColumn()">ËøΩÂä†</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="themeModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">üé® „ÉÜ„Éº„ÉûË®≠ÂÆö</span>
                <button class="modal-close" onclick="closeThemeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Coolors URL„Åã„ÇâÈÅ©Áî®</label>
                    <div style="display:flex;gap:8px;">
                        <input type="text" class="form-input" id="coolorsInput" placeholder="https://coolors.co/..." style="flex:1;">
                        <button class="add-btn" onclick="applyCoolors()">ÈÅ©Áî®</button>
                    </div>
                    <p id="themeError" style="color:#ef4444;font-size:12px;margin-top:6px;"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">„Éó„É™„Çª„ÉÉ„Éà</label>
                    <div id="presetGrid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-full btn-primary" onclick="closeThemeModal()">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="habitModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Êñ∞„Åó„ÅÑÁøíÊÖ£</span>
                <button class="modal-close" onclick="closeHabitModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ÁµµÊñáÂ≠ó</label>
                    <div class="emoji-grid" id="emojiGrid"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">ÁøíÊÖ£Âêç</label>
                    <input type="text" class="form-input" id="habitNameInput" placeholder="‰æã: Êó©Ëµ∑„Åç„ÄÅÈÅãÂãï30ÂàÜ...">
                </div>
            </div>
            <div class="modal-footer">
                <div class="btn-row">
                    <button class="btn-full btn-secondary" onclick="closeHabitModal()">„Ç≠„É£„É≥„Çª„É´</button>
                    <button class="btn-full btn-accent" onclick="addHabit()">ËøΩÂä†</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="habitManageModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">‚öôÔ∏è ÁøíÊÖ£„ÅÆÁÆ°ÁêÜ</span>
                <button class="modal-close" onclick="closeHabitManageModal()">‚úï</button>
            </div>
            <div class="modal-body" id="habitManageBody">
                <!-- ÁøíÊÖ£„É™„Çπ„Éà„Åå„Åì„Åì„Å´ÂÖ•„Çã -->
            </div>
            <div class="modal-footer">
                <button class="btn-full btn-secondary" onclick="closeHabitManageModal()">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="columnOrderModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">‚ÜîÔ∏è „Ç´„É©„É†‰∏¶„Å≥Êõø„Åà</span>
                <button class="modal-close" onclick="closeColumnOrderModal()">‚úï</button>
            </div>
            <div class="modal-body" id="columnOrderBody">
                <!-- „Ç´„É©„É†„É™„Çπ„Éà„Åå„Åì„Åì„Å´ÂÖ•„Çã -->
            </div>
            <div class="modal-footer">
                <button class="btn-full btn-secondary" onclick="closeColumnOrderModal()">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="scoreModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="scoreModalTitle">„Çπ„Ç≥„Ç¢„ÇíÈÅ∏Êäû</span>
                <button class="modal-close" onclick="closeScoreModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="score-grid" id="scoreGrid"></div>
                <p style="text-align:center;font-size:12px;color:#999;margin-top:12px;">0: Êú™ÂÆüÊñΩ ÔΩú 1-2: „ÅÑ„Åæ„ÅÑ„Å° ÔΩú 3: ÊôÆÈÄö ÔΩú 4-5: ËâØ„ÅÑ</p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="diaryModal">
        <div class="modal diary-modal">
            <div class="modal-header">
                <span class="modal-title">üìù Êó•Ë®òÂÖ•Âäõ</span>
                <button class="modal-close" onclick="closeDiaryModal()">‚úï</button>
            </div>
            <div class="diary-date-nav">
                <button class="diary-nav-btn" onclick="diaryPrevDay()">‚óÄ</button>
                <span class="diary-date" id="diaryDateLabel">2025/12/1</span>
                <button class="diary-nav-btn" onclick="diaryNextDay()">‚ñ∂</button>
                <button class="diary-today-btn" onclick="diaryGoToday()">‰ªäÊó•</button>
            </div>
            <div class="diary-scores-row">
                <div class="diary-score-block">
                    <label class="diary-score-label">‚òÄÔ∏è Êòº„ÅÆ‰ªï‰∫ã</label>
                    <div class="diary-score-input-row">
                        <button class="diary-score-btn minus" onclick="adjustDayScore(-1)">‚àí</button>
                        <input type="number" class="diary-score-input" id="dayScoreInput" value="0" min="0" max="100" inputmode="numeric" pattern="[0-9]*" onchange="saveDayScore()" onkeyup="if(event.key==='Enter'||event.keyCode===13){this.blur();}">
                        <button class="diary-score-btn plus" onclick="adjustDayScore(1)">Ôºã</button>
                    </div>
                </div>
                <div class="diary-score-block">
                    <label class="diary-score-label">üåô Â§ú„ÅÆ‰ªï‰∫ã</label>
                    <div class="diary-score-input-row">
                        <button class="diary-score-btn minus" onclick="adjustNightScore(-1)">‚àí</button>
                        <input type="number" class="diary-score-input" id="nightScoreInput" value="0" min="0" max="100" inputmode="numeric" pattern="[0-9]*" onchange="saveNightScore()" onkeyup="if(event.key==='Enter'||event.keyCode===13){this.blur();}">
                        <button class="diary-score-btn plus" onclick="adjustNightScore(1)">Ôºã</button>
                    </div>
                </div>
            </div>
            <div class="diary-habit-tabs" id="diaryHabitTabs">
                <!-- ÁøíÊÖ£„Çø„Éñ„Åå„Åì„Åì„Å´ÂÖ•„Çã -->
            </div>
            <div class="diary-input-area" id="diaryInputArea">
                <!-- ÈÅ∏Êäû‰∏≠„ÅÆÁøíÊÖ£„ÅÆÂÖ•Âäõ„Ç®„É™„Ç¢ -->
            </div>
            <div class="diary-nav-arrows">
                <button class="diary-arrow-btn" onclick="diaryPrevHabit()">‚óÄ Ââç</button>
                <button class="diary-arrow-btn" onclick="diaryNextHabit()">Ê¨° ‚ñ∂</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="statsModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <span class="modal-title">üìà ÈõÜË®à„ÉªÂàÜÊûê</span>
                <button class="modal-close" onclick="closeStatsModal()">‚úï</button>
            </div>
            <div class="modal-body" style="max-height:65vh;" id="statsBody"></div>
            <div class="modal-footer">
                <button class="btn-full btn-accent" onclick="closeStatsModal()">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <div class="confirm-backdrop" id="confirmBack" onclick="closeConfirm()"></div>
    <div class="confirm-dialog" id="confirmDlg">
        <h3 id="confirmTitle">Á¢∫Ë™ç</h3>
        <p id="confirmMsg">Êú¨ÂΩì„Å´„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü</p>
        <div class="confirm-btns">
            <button class="cancel-btn" onclick="closeConfirm()">„Ç≠„É£„É≥„Çª„É´</button>
            <button class="confirm-btn" id="confirmOk" onclick="execConfirm()">ÂÆüË°å</button>
        </div>
    </div>

    <script>
        // ===== ÂÆöÊï∞„ÉªÂ§âÊï∞ =====
        // 2025Âπ¥12Êúà1Êó•„Äú2026Âπ¥12Êúà31Êó•
        const START_DATE = new Date(2025, 11, 1); // 2025/12/1
        const END_DATE = new Date(2026, 11, 31);  // 2026/12/31
        const SCORE_COLORS = ['#f3f4f6', '#fecaca', '#fed7aa', '#fef08a', '#bbf7d0', '#86efac'];
        const DAY_NAMES = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];

        let theme = { primary: '#f49097', secondary: '#dfb2f4', accent: '#55d6c2', highlight: '#f5e960', bg: '#f2f5ff' };
        const PRESETS = [
            { name: '„Éë„Çπ„ÉÜ„É´', colors: { primary: '#f49097', secondary: '#dfb2f4', accent: '#55d6c2', highlight: '#f5e960', bg: '#f2f5ff' }},
            { name: '„É≠„Éº„Ç∫', colors: { primary: '#f92a82', secondary: '#ed7b84', accent: '#7eb77f', highlight: '#f5dbcb', bg: '#fff5f5' }},
            { name: '„Ç™„Éº„Ç∑„É£„É≥', colors: { primary: '#0077b6', secondary: '#00b4d8', accent: '#90e0ef', highlight: '#caf0f8', bg: '#f0f9ff' }},
            { name: '„Éï„Ç©„É¨„Çπ„Éà', colors: { primary: '#2d6a4f', secondary: '#40916c', accent: '#74c69d', highlight: '#b7e4c7', bg: '#f0fdf4' }}
        ];

        let columns = [
            { id: 'todo', title: 'TODO', color: theme.primary },
            { id: 'doing', title: 'ÈÄ≤Ë°å‰∏≠', color: theme.secondary },
            { id: 'done', title: 'ÂÆå‰∫Ü', color: theme.accent }
        ];
        let tasks = { todo: [], doing: [], done: [] };
        let currentTask = null, currentCol = null;

        // ÁøíÊÖ£„ÅØÁ©∫„Åß„Çπ„Çø„Éº„Éà
        let habits = [];
        let habitScores = {};  // { "2025-12-01": { habitId: { score: 5, note: "„É°„É¢" } } }
        let habitNotes = {};   // ÂÇôËÄÉÁî®ÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÂà•ÁÆ°ÁêÜ„ÇÇÂèØÔºâ
        let editScore = null;
        let selEmoji = '‚ú®';
        let statsMonth = { year: new Date().getFullYear(), month: new Date().getMonth() };
        let statsTab = 'overview';
        let confirmCb = null;
        let diaryDate = new Date(); // Êó•Ë®ò„ÅÆÁèæÂú®Ë°®Á§∫Êó•
        let isSyncing = true; // ÂêåÊúü‰∏≠„Éï„É©„Ç∞ÔºàÂàùÊúüÂåñÊôÇ„ÅØtrueÔºâ

        // ===== ÂàùÊúüÂåñ =====
        document.addEventListener('DOMContentLoaded', () => {
            // „Åæ„Åö„É≠„Éº„Ç´„É´„Åã„ÇâË™≠„ÅøËæº„Çì„ÅßÂç≥ÊôÇË°®Á§∫
            loadFromLocal();
            applyTheme();
            renderKanban();
            setupInputs();
            renderHabitTable();
            
            // „É≠„Éº„Ç´„É´„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const localHasData = Object.keys(tasks).some(col => tasks[col] && tasks[col].length > 0) 
                              || (habits && habits.length > 0);
            
            if (localHasData) {
                // „É≠„Éº„Ç´„É´„Å´„Éá„Éº„Çø„ÅÇ„Çä ‚Üí Âç≥‰Ωø„Åà„Çã„ÄÅË£è„ÅßÂêåÊúü
                syncFromServerQuiet();
            } else {
                // „É≠„Éº„Ç´„É´„ÅåÁ©∫ ‚Üí ÂêåÊúüÂÆå‰∫Ü„Åæ„ÅßÂæÖ„Å§
                syncFromServerBlocking();
            }
            
            setTimeout(scrollToToday, 200);
            
            // Service WorkerÁôªÈå≤
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(e => console.log('SW registration failed:', e));
            }
        });

        // ===== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ =====
        const fmt = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const isToday = d => fmt(d) === fmt(new Date());
        const isWknd = d => d.getDay() === 0 || d.getDay() === 6;
        const daysAgo = s => Math.floor((new Date() - new Date(s)) / 86400000);
        const txtColor = c => { const rgb = parseInt(c.slice(1), 16); return ((0.299 * ((rgb >> 16) & 0xff) + 0.587 * ((rgb >> 8) & 0xff) + 0.114 * (rgb & 0xff)) / 255) > 0.6 ? '#333' : '#fff'; };
        const esc = t => { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; };

        // ===== „Çπ„Éà„É¨„Éº„Ç∏ =====
        const API_URL = 'https://script.google.com/macros/s/AKfycbzu4GZM8tpiOmy1gbIdLhzW9oAePeu8EUEr6mj4VSUaFyaKNytjZeToVXLMsZ0PEJvGlQ/exec';
        let saveTimer = null;

        // ÂÄãÂà•APIÂëº„Å≥Âá∫„ÅóÔºàÂ∑ÆÂàÜÊõ¥Êñ∞Áî®Ôºâ
        async function apiCall(action, data) {
            try {
                updateSyncBadge('syncing', '‰øùÂ≠ò‰∏≠...');
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action, ...data })
                });
                const result = await response.json();
                if (result.success) {
                    updateSyncBadge('success', '‰øùÂ≠òÂÆå‰∫Ü');
                    setTimeout(() => updateSyncBadge('success', 'ÂêåÊúüÊ∏à'), 2000);
                } else {
                    console.error('API error:', result.error);
                    updateSyncBadge('error', '„Ç®„É©„Éº');
                }
                return result;
            } catch(e) {
                console.error('API call error:', e);
                updateSyncBadge('error', '„Ç®„É©„Éº');
                return { success: false, error: e.toString() };
            }
        }

        // Èùô„Åã„Å´ÂêåÊúüÔºà„É≠„Éº„Ç´„É´„Å´„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ‚Üí „Åß„ÇÇÊìç‰Ωú„ÅØ„Éñ„É≠„ÉÉ„ÇØ
        async function syncFromServerQuiet() {
            console.log('syncFromServerQuiet() ÈñãÂßã');
            isSyncing = true;
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('loadingText').textContent = 'ÂêåÊúü‰∏≠...';
            
            try {
                const response = await fetch(API_URL + '?action=load');
                const data = await response.json();
                
                console.log('„Çµ„Éº„Éê„Éº„Åã„Çâ„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫Ü');
                
                if (data && data.success) {
                    // Â∏∏„Å´„Çµ„Éº„Éê„Éº„ÅÆ„Éá„Éº„Çø„Çí‰ΩøÁî®Ôºà„Çµ„Éº„Éê„Éº„ÅåÊ≠£Ôºâ
                    tasks = data.tasks || {};
                    if (data.columns && data.columns.length > 0) columns = data.columns;
                    habits = data.habits || [];
                    habitScores = data.habitScores || {};
                    habitNotes = data.habitNotes || {};
                    dailyScores = data.dailyScores || {};
                    if (data.settings && data.settings.theme) theme = data.settings.theme;
                    
                    console.log('„Çµ„Éº„Éê„Éº„Éá„Éº„Çø„ÅßÊõ¥Êñ∞: „Çø„Çπ„ÇØÊï∞=' + Object.values(tasks).flat().length);
                    
                    applyTheme();
                    renderKanban();
                    renderHabitTable();
                    saveToLocal();
                    updateSyncBadge('success', 'ÂêåÊúüÂÆå‰∫Ü');
                }
            } catch(e) {
                console.error('Sync error:', e);
                updateSyncBadge('error', '„Ç™„Éï„É©„Ç§„É≥');
            } finally {
                document.getElementById('loading').classList.add('hidden');
                isSyncing = false;
                console.log('syncFromServerQuiet() ÂÆå‰∫Ü: isSyncing=false');
            }
        }

        // „Éñ„É≠„ÉÉ„Ç≠„É≥„Ç∞ÂêåÊúüÔºà„É≠„Éº„Ç´„É´„ÅåÁ©∫„ÅÆÂ†¥ÂêàÔºâ
        async function syncFromServerBlocking() {
            isSyncing = true;
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('loadingText').textContent = 'Ë™≠Ëæº‰∏≠...';
            
            try {
                const response = await fetch(API_URL + '?action=load');
                const data = await response.json();
                
                if (data && data.success) {
                    tasks = data.tasks || {};
                    if (data.columns && data.columns.length > 0) columns = data.columns;
                    habits = data.habits || [];
                    habitScores = data.habitScores || {};
                    habitNotes = data.habitNotes || {};
                    dailyScores = data.dailyScores || {};
                    if (data.settings && data.settings.theme) theme = data.settings.theme;
                    
                    applyTheme();
                    renderKanban();
                    renderHabitTable();
                    saveToLocal();
                    updateSyncBadge('success', 'ÂêåÊúüÂÆå‰∫Ü');
                }
            } catch(e) {
                console.error('Sync error:', e);
                updateSyncBadge('error', '„Ç™„Éï„É©„Ç§„É≥');
            } finally {
                document.getElementById('loading').classList.add('hidden');
                isSyncing = false;
            }
        }

        function loadFromLocal() {
            try {
                const t = localStorage.getItem('kanban_tasks_v2');
                const c = localStorage.getItem('kanban_cols_v2');
                const th = localStorage.getItem('kanban_theme_v2');
                const h = localStorage.getItem('habits_v2');
                const hs = localStorage.getItem('habit_scores_v2');
                const hn = localStorage.getItem('habit_notes_v2');
                const ds = localStorage.getItem('daily_scores_v2');
                if (t) tasks = JSON.parse(t);
                if (c) columns = JSON.parse(c);
                if (th) theme = JSON.parse(th);
                if (h) habits = JSON.parse(h);
                if (hs) habitScores = JSON.parse(hs);
                if (hn) habitNotes = JSON.parse(hn);
                if (ds) dailyScores = JSON.parse(ds);
            } catch (e) { console.error('Local load error:', e); }
        }

        function saveToLocal() {
            try {
                localStorage.setItem('kanban_tasks_v2', JSON.stringify(tasks));
                localStorage.setItem('kanban_cols_v2', JSON.stringify(columns));
                localStorage.setItem('kanban_theme_v2', JSON.stringify(theme));
                localStorage.setItem('habits_v2', JSON.stringify(habits));
                localStorage.setItem('habit_scores_v2', JSON.stringify(habitScores));
                localStorage.setItem('habit_notes_v2', JSON.stringify(habitNotes));
                localStorage.setItem('daily_scores_v2', JSON.stringify(dailyScores));
            } catch (e) { console.error('Local save error:', e); }
        }

        function save() {
            // ÂêåÊúü‰∏≠„ÅØ‰øùÂ≠ò„Åó„Å™„ÅÑÔºà„Éá„Éº„ÇøÊ∂àÂ§±Èò≤Ê≠¢Ôºâ
            if (isSyncing) {
                console.log('save() „Çπ„Ç≠„ÉÉ„Éó: isSyncing=true');
                return;
            }
            
            saveToLocal();
        }

        function updateSyncBadge(status, text) {
            const badge = document.getElementById('syncBadge');
            badge.textContent = text;
            badge.className = 'sync-badge ' + status;
        }

        // ===== „Çø„ÉñÂàáÊõø =====
        function switchTab(tab) {
            document.querySelectorAll('.main-tab').forEach((t, i) => t.classList.toggle('active', (i === 0 && tab === 'todo') || (i === 1 && tab === 'habit')));
            document.getElementById('todoTab').classList.toggle('active', tab === 'todo');
            document.getElementById('habitTab').classList.toggle('active', tab === 'habit');
            if (tab === 'habit') {
                // „Çø„ÉñË°®Á§∫Âæå„Å´Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„Çπ„ÇØ„É≠„Éº„É´
                setTimeout(scrollToToday, 300);
            }
        }

        // ===== TODO =====
        function renderKanban() {
            const k = document.getElementById('kanban');
            
            // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Çí‰øùÂ≠ò
            const scrollPositions = {};
            document.querySelectorAll('.task-list').forEach(list => {
                const col = list.closest('.column')?.dataset.col;
                if (col) scrollPositions[col] = list.scrollTop;
            });
            const kanbanScroll = k.scrollLeft;
            
            k.innerHTML = columns.map((c, colIdx) => `
                <div class="column ${c.id}" data-col="${c.id}" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="drop(event,'${c.id}')">
                    <div class="column-header" style="background:${c.color};color:${txtColor(c.color)}">
                        <div><span class="column-title">${c.title}</span><span class="column-count">${(tasks[c.id]||[]).length}</span></div>
                        ${!['todo','doing','done'].includes(c.id) ? `<button class="column-delete" onclick="delColumn('${c.id}')">‚úï</button>` : ''}
                    </div>
                    <div class="task-list">${renderTasks(c.id, colIdx)}</div>
                </div>
            `).join('');
            document.getElementById('taskCount').textContent = Object.values(tasks).flat().length + '‰ª∂';
            
            // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„ÇíÂæ©ÂÖÉ
            document.querySelectorAll('.task-list').forEach(list => {
                const col = list.closest('.column')?.dataset.col;
                if (col && scrollPositions[col]) list.scrollTop = scrollPositions[col];
            });
            k.scrollLeft = kanbanScroll;
            
            // „É¢„Éê„Ç§„É´„Ç´„É©„É†ÈÅ∏Êäû„ÇíÊõ¥Êñ∞
            updateMobileColTabs();
            
            saveToLocal();
        }
        
        // ÊèèÁîª„ÅÆ„ÅøÔºà„Çµ„Éº„Éê„Éº‰øùÂ≠ò„Åó„Å™„ÅÑÁâàÔºâ
        function renderKanbanOnly() {
            const k = document.getElementById('kanban');
            
            // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Çí‰øùÂ≠ò
            const scrollPositions = {};
            document.querySelectorAll('.task-list').forEach(list => {
                const col = list.closest('.column')?.dataset.col;
                if (col) scrollPositions[col] = list.scrollTop;
            });
            const kanbanScroll = k.scrollLeft;
            
            k.innerHTML = columns.map((c, colIdx) => `
                <div class="column ${c.id}" data-col="${c.id}" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="drop(event,'${c.id}')">
                    <div class="column-header" style="background:${c.color};color:${txtColor(c.color)}">
                        <div><span class="column-title">${c.title}</span><span class="column-count">${(tasks[c.id]||[]).length}</span></div>
                        ${!['todo','doing','done'].includes(c.id) ? `<button class="column-delete" onclick="delColumn('${c.id}')">‚úï</button>` : ''}
                    </div>
                    <div class="task-list">${renderTasks(c.id, colIdx)}</div>
                </div>
            `).join('');
            document.getElementById('taskCount').textContent = Object.values(tasks).flat().length + '‰ª∂';
            
            // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„ÇíÂæ©ÂÖÉ
            document.querySelectorAll('.task-list').forEach(list => {
                const col = list.closest('.column')?.dataset.col;
                if (col && scrollPositions[col]) list.scrollTop = scrollPositions[col];
            });
            k.scrollLeft = kanbanScroll;
            
            // „É¢„Éê„Ç§„É´„Ç´„É©„É†ÈÅ∏Êäû„ÇíÊõ¥Êñ∞
            updateMobileColTabs();
            
            saveToLocal();
        }
        
        let mobileSelectedCol = 'todo';
        
        function updateMobileColTabs() {
            const container = document.getElementById('mobileColTabs');
            if (!container) return;
            
            container.innerHTML = columns.map(c => 
                `<button class="mobile-col-tab ${c.id === mobileSelectedCol ? 'active' : ''}" 
                         onclick="selectMobileCol('${c.id}')">${c.title}</button>`
            ).join('');
        }
        
        function selectMobileCol(colId) {
            mobileSelectedCol = colId;
            updateMobileColTabs();
        }
        
        function expandMobileInput() {
            document.getElementById('mobileInputCollapsed').classList.add('hidden');
            document.getElementById('mobileInputExpanded').classList.remove('hidden');
            // ÂÖ•ÂäõÊ¨Ñ„Å´„Éï„Ç©„Éº„Ç´„Çπ
            setTimeout(() => document.getElementById('mobileInput').focus(), 100);
        }
        
        function collapseMobileInput() {
            document.getElementById('mobileInputCollapsed').classList.remove('hidden');
            document.getElementById('mobileInputExpanded').classList.add('hidden');
        }

        function renderTasks(col, colIdx) {
            const list = tasks[col] || [];
            if (!list.length) return `<div class="empty-column"><div class="empty-icon">üìã</div><span>„Çø„Çπ„ÇØ„Å™„Åó</span></div>`;
            return list.map((t, idx) => {
                const d = daysAgo(t.createdAt);
                const bc = d <= 1 ? theme.accent : d <= 3 ? theme.highlight : theme.primary;
                return `<div class="task-card ${t.important ? 'important' : ''} ${col === 'done' ? 'done-task' : ''}" 
                            draggable="true" 
                            data-id="${t.id}" 
                            data-col="${col}" 
                            data-idx="${idx}"
                            ondragstart="dragStart(event)" 
                            ondragend="dragEnd(event)" 
                            ondragover="taskDragOver(event, '${col}', ${idx})"
                            ondragleave="taskDragLeave(event)"
                            ondrop="taskDrop(event, '${col}', ${idx})"
                            onclick="openMemo('${t.id}','${col}')">
                    <div class="days-badge" style="background:${bc};color:${txtColor(bc)}">${d}</div>
                    <div class="task-title">${esc(t.title)}</div>
                    ${t.memos?.length ? `<div class="task-meta">üí¨ ${t.memos.length}</div>` : ''}
                    <div class="task-actions">
                        <div class="task-move-btns">
                            <button class="task-move-btn" onclick="event.stopPropagation();moveTaskPrev('${t.id}','${col}')" ${colIdx === 0 ? 'disabled' : ''}>‚óÄ</button>
                            <button class="task-move-btn" onclick="event.stopPropagation();moveTaskNext('${t.id}','${col}')" ${colIdx === columns.length - 1 ? 'disabled' : ''}>‚ñ∂</button>
                        </div>
                        <button class="task-action-btn star-btn pc-only ${t.important ? 'active' : ''}" onclick="event.stopPropagation();toggleStar('${t.id}','${col}')">‚òÖ</button>
                        ${col !== 'done' ? `<button class="task-action-btn complete-btn pc-only" onclick="event.stopPropagation();confirmComplete('${t.id}','${col}')">‚úì</button>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function setupInputs() {
            ['pc', 'mobile'].forEach(t => {
                const inp = document.getElementById(t + 'Input');
                const btn = document.getElementById(t + 'Btn');
                inp.addEventListener('input', () => { btn.disabled = !inp.value.trim(); });
                inp.addEventListener('keydown', e => { if (e.key === 'Enter' && inp.value.trim()) addTask(t); });
            });
        }

        function addTask(t) {
            const inp = document.getElementById(t + 'Input');
            const btn = document.getElementById(t + 'Btn');
            const title = inp.value.trim();
            if (!title) return;
            
            // „É¢„Éê„Ç§„É´„ÅÆÂ†¥Âêà„ÅØÈÅ∏Êäû„Åó„Åü„Ç´„É©„É†„Å´ËøΩÂä†
            let targetCol = 'todo';
            if (t === 'mobile') {
                targetCol = mobileSelectedCol || 'todo';
            }
            
            const newTask = { id: String(Date.now()), title, important: false, createdAt: new Date().toISOString(), memos: [] };
            
            if (!tasks[targetCol]) tasks[targetCol] = [];
            tasks[targetCol].unshift(newTask);
            renderKanbanOnly();
            inp.value = ''; btn.disabled = true;
            
            // „Çµ„Éº„Éê„Éº„Å´ËøΩÂä†
            apiCall('addTask', { task: newTask, columnId: targetCol });
            
            // „É¢„Éê„Ç§„É´„ÅÆÂ†¥Âêà„ÅØËøΩÂä†Âæå„Å´ÊúÄÂ∞èÂåñ
            if (t === 'mobile') {
                collapseMobileInput();
            }
        }

        let dragEl = null;
        let dragFromCol = null;
        let dragFromIdx = null;

        function dragStart(e) { 
            dragEl = e.target; 
            dragFromCol = e.target.dataset.col;
            dragFromIdx = parseInt(e.target.dataset.idx);
            e.target.classList.add('dragging'); 
            e.dataTransfer.effectAllowed = 'move';
        }

        function dragEnd(e) { 
            e.target.classList.remove('dragging'); 
            document.querySelectorAll('.column').forEach(c => c.classList.remove('drag-over')); 
            document.querySelectorAll('.task-card').forEach(c => c.classList.remove('drag-over-top', 'drag-over-bottom'));
            dragEl = null;
            dragFromCol = null;
            dragFromIdx = null;
        }

        function taskDragOver(e, col, idx) {
            e.preventDefault();
            e.stopPropagation();
            if (!dragEl) return;
            
            const card = e.target.closest('.task-card');
            if (!card || card === dragEl) return;
            
            // „Ç´„Éº„Éâ„ÅÆ‰∏äÂçäÂàÜ„Åã‰∏ãÂçäÂàÜ„Åã„ÇíÂà§ÂÆö
            const rect = card.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            const isTop = e.clientY < midY;
            
            // ‰ªñ„ÅÆ„Ç´„Éº„Éâ„ÅÆ„Éè„Ç§„É©„Ç§„Éà„Çí„ÇØ„É™„Ç¢
            document.querySelectorAll('.task-card').forEach(c => c.classList.remove('drag-over-top', 'drag-over-bottom'));
            
            card.classList.add(isTop ? 'drag-over-top' : 'drag-over-bottom');
        }

        function taskDragLeave(e) {
            const card = e.target.closest('.task-card');
            if (card) {
                card.classList.remove('drag-over-top', 'drag-over-bottom');
            }
        }

        function taskDrop(e, toCol, toIdx) {
            e.preventDefault();
            e.stopPropagation();
            
            document.querySelectorAll('.task-card').forEach(c => c.classList.remove('drag-over-top', 'drag-over-bottom'));
            document.querySelectorAll('.column').forEach(c => c.classList.remove('drag-over'));
            
            if (!dragEl) return;
            
            const id = dragEl.dataset.id;
            const fromCol = dragFromCol;
            const fromIdx = dragFromIdx;
            
            // „Éâ„É≠„ÉÉ„Éó‰ΩçÁΩÆ„ÇíË®àÁÆóÔºà‰∏äÂçäÂàÜ„Å™„ÇâÂâç„ÄÅ‰∏ãÂçäÂàÜ„Å™„ÇâÂæå„ÇçÔºâ
            const card = e.target.closest('.task-card');
            let insertIdx = toIdx;
            if (card) {
                const rect = card.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                if (e.clientY >= midY) {
                    insertIdx = toIdx + 1;
                }
            }
            
            // Âêå„Åò„Ç´„É©„É†ÂÜÖ„ÅÆÁßªÂãï
            if (fromCol === toCol) {
                if (fromIdx === insertIdx || fromIdx + 1 === insertIdx) {
                    dragEl = null;
                    return; // Âêå„Åò‰ΩçÁΩÆ„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
                }
                
                const task = tasks[fromCol].splice(fromIdx, 1)[0];
                // ÂâäÈô§Âæå„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπË™øÊï¥
                if (fromIdx < insertIdx) {
                    insertIdx--;
                }
                tasks[toCol].splice(insertIdx, 0, task);
            } else {
                // Âà•„Ç´„É©„É†„Å∏„ÅÆÁßªÂãï
                const task = tasks[fromCol].splice(fromIdx, 1)[0];
                if (!tasks[toCol]) tasks[toCol] = [];
                tasks[toCol].splice(insertIdx, 0, task);
            }
            
            renderKanban();
            dragEl = null;
            dragFromCol = null;
            dragFromIdx = null;
        }

        function drop(e, toCol) {
            e.preventDefault();
            document.querySelectorAll('.column').forEach(c => c.classList.remove('drag-over'));
            document.querySelectorAll('.task-card').forEach(c => c.classList.remove('drag-over-top', 'drag-over-bottom'));
            
            if (!dragEl) return;
            const id = dragEl.dataset.id, fromCol = dragEl.dataset.col;
            if (fromCol === toCol) return;
            const idx = tasks[fromCol].findIndex(t => String(t.id) === id);
            if (idx === -1) return;
            const task = tasks[fromCol].splice(idx, 1)[0];
            if (!tasks[toCol]) tasks[toCol] = [];
            tasks[toCol].unshift(task); // ‰∏ÄÁï™‰∏ä„Å´ËøΩÂä†
            renderKanbanOnly();
            
            // „Çµ„Éº„Éê„Éº„Å´ÁßªÂãï„ÇíÈÄöÁü•
            apiCall('moveTask', { taskId: id, toColumn: toCol });
            
            dragEl = null;
            dragFromCol = null;
            dragFromIdx = null;
        }

        // „Çø„Çπ„ÇØ„ÇíÂâç„ÅÆ„Ç´„É©„É†„Å´ÁßªÂãï
        function moveTaskPrev(id, col) {
            const colIdx = columns.findIndex(c => c.id === col);
            if (colIdx <= 0) return;
            
            const prevCol = columns[colIdx - 1].id;
            const idx = tasks[col].findIndex(t => String(t.id) === String(id));
            if (idx === -1) return;
            
            const task = tasks[col].splice(idx, 1)[0];
            if (!tasks[prevCol]) tasks[prevCol] = [];
            tasks[prevCol].unshift(task); // ‰∏ÄÁï™‰∏ä„Å´ËøΩÂä†
            renderKanbanOnly();
            
            // „Çµ„Éº„Éê„Éº„Å´ÁßªÂãï„ÇíÈÄöÁü•
            apiCall('moveTask', { taskId: String(id), toColumn: prevCol });
        }

        // „Çø„Çπ„ÇØ„ÇíÊ¨°„ÅÆ„Ç´„É©„É†„Å´ÁßªÂãï
        function moveTaskNext(id, col) {
            const colIdx = columns.findIndex(c => c.id === col);
            if (colIdx < 0 || colIdx >= columns.length - 1) return;
            
            const nextCol = columns[colIdx + 1].id;
            const idx = tasks[col].findIndex(t => String(t.id) === String(id));
            if (idx === -1) return;
            
            const task = tasks[col].splice(idx, 1)[0];
            if (!tasks[nextCol]) tasks[nextCol] = [];
            tasks[nextCol].unshift(task); // ‰∏ÄÁï™‰∏ä„Å´ËøΩÂä†
            renderKanbanOnly();
            
            // „Çµ„Éº„Éê„Éº„Å´ÁßªÂãï„ÇíÈÄöÁü•
            apiCall('moveTask', { taskId: String(id), toColumn: nextCol });
        }

        function toggleStar(id, col) {
            const idx = tasks[col].findIndex(x => String(x.id) === String(id));
            if (idx === -1) return;
            
            const t = tasks[col][idx];
            t.important = !t.important;
            
            // ÈáçË¶Å„Çí‰ªò„Åë„Åü„Çâ‰∏ÄÁï™‰∏ä„Å´ÁßªÂãï
            if (t.important && idx > 0) {
                tasks[col].splice(idx, 1);
                tasks[col].unshift(t);
            }
            
            renderKanbanOnly();
            
            // „Çµ„Éº„Éê„Éº„Å´Êõ¥Êñ∞„ÇíÈÄöÁü•
            apiCall('updateTask', { task: t, columnId: col });
        }

        function confirmComplete(id, col) {
            const t = tasks[col].find(x => String(x.id) === String(id));
            if (!t) return;
            showConfirm('ÂÆå‰∫ÜÁ¢∫Ë™ç', `„Äå${t.title}„Äç„ÇíÂÆå‰∫Ü„Å´„Åó„Åæ„Åô„ÅãÔºü`, 'ÂÆå‰∫Ü', 'complete', () => {
                const idx = tasks[col].findIndex(x => String(x.id) === String(id));
                if (idx !== -1) { 
                    const task = tasks[col].splice(idx, 1)[0]; 
                    tasks.done.unshift(task); 
                    renderKanbanOnly(); 
                    
                    // „Çµ„Éº„Éê„Éº„Å´ÁßªÂãï„ÇíÈÄöÁü•
                    apiCall('moveTask', { taskId: String(id), toColumn: 'done' });
                }
            });
        }

        function openMemo(id, col) {
            const t = tasks[col].find(x => String(x.id) === String(id));
            if (!t) return;
            currentTask = t; currentCol = col;
            document.getElementById('memoTitle').textContent = t.title;
            document.getElementById('titleInput').value = t.title;
            updateImportantUI(t.important);
            renderMemoList();
            document.getElementById('memoModal').classList.add('active');
        }

        function closeMemoModal() { document.getElementById('memoModal').classList.remove('active'); document.getElementById('memoInput').value = ''; currentTask = null; currentCol = null; }

        function updateImportantUI(on) {
            const btn = document.getElementById('importantBtn');
            const knob = document.getElementById('importantKnob');
            btn.style.background = on ? theme.primary : '#e5e7eb';
            knob.style.transform = on ? 'translateX(18px)' : 'translateX(0)';
        }

        function toggleImportant() { 
            if (!currentTask) return; 
            currentTask.important = !currentTask.important; 
            updateImportantUI(currentTask.important);
            
            // ÈáçË¶Å„Çí‰ªò„Åë„Åü„Çâ‰∏ÄÁï™‰∏ä„Å´ÁßªÂãï
            if (currentTask.important) {
                const idx = tasks[currentCol].findIndex(t => t.id === currentTask.id);
                if (idx > 0) {
                    tasks[currentCol].splice(idx, 1);
                    tasks[currentCol].unshift(currentTask);
                }
            }
            
            renderKanbanOnly(); 
            apiCall('updateTask', { task: currentTask, columnId: currentCol });
        }
        function saveTitle() { 
            if (!currentTask) return; 
            const v = document.getElementById('titleInput').value.trim(); 
            if (v) { 
                currentTask.title = v; 
                document.getElementById('memoTitle').textContent = v; 
                renderKanbanOnly(); 
                apiCall('updateTask', { task: currentTask, columnId: currentCol });
            } 
        }
        function addMemo() {
            const inp = document.getElementById('memoInput');
            const txt = inp.value.trim();
            if (!txt || !currentTask) return;
            if (!currentTask.memos) currentTask.memos = [];
            currentTask.memos.unshift({ text: txt, timestamp: new Date().toISOString() });
            renderMemoList(); 
            renderKanbanOnly(); 
            inp.value = '';
            apiCall('updateTask', { task: currentTask, columnId: currentCol });
        }

        function renderMemoList() {
            const list = document.getElementById('memoList');
            if (!currentTask?.memos?.length) { list.innerHTML = '<div style="text-align:center;padding:30px;color:#d1d5db;">üí¨ „Åæ„Å†„É°„É¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>'; return; }
            list.innerHTML = currentTask.memos.map(m => {
                const d = new Date(m.timestamp);
                return `<div style="background:#f9fafb;border-radius:10px;padding:12px;margin-bottom:8px;"><div style="font-size:11px;color:#9ca3af;margin-bottom:4px;">${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}</div><div style="font-size:13px;line-height:1.4;">${esc(m.text)}</div></div>`;
            }).join('');
        }

        function confirmDelete() {
            showConfirm('ÂâäÈô§Á¢∫Ë™ç', `„Äå${currentTask.title}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`, 'ÂâäÈô§', 'danger', () => {
                const taskId = currentTask.id;
                const idx = tasks[currentCol].findIndex(t => t.id === currentTask.id);
                if (idx !== -1) { 
                    tasks[currentCol].splice(idx, 1); 
                    renderKanbanOnly(); 
                    apiCall('deleteTask', { taskId: String(taskId) });
                }
                closeMemoModal();
            });
        }

        let selColColor = '#f49097';
        function openColumnModal() { selColColor = theme.primary; renderColColors(); document.getElementById('colNameInput').value = ''; document.getElementById('columnModal').classList.add('active'); }
        function closeColumnModal() { document.getElementById('columnModal').classList.remove('active'); }
        function renderColColors() {
            const colors = [theme.primary, theme.secondary, theme.accent, theme.highlight, '#6366f1', '#64748b'];
            document.getElementById('colColorPicker').innerHTML = colors.map(c => `<button style="width:40px;height:40px;border:${c === selColColor ? '3px solid #333' : 'none'};border-radius:10px;background:${c};cursor:pointer;" onclick="selColColor='${c}';renderColColors()"></button>`).join('');
        }
        function addColumn() {
            const name = document.getElementById('colNameInput').value.trim();
            if (!name) return;
            const id = 'col_' + Date.now();
            columns.push({ id, title: name, color: selColColor });
            tasks[id] = [];
            renderKanban();
            closeColumnModal();
        }
        function delColumn(id) { if (['todo','doing','done'].includes(id)) return; columns = columns.filter(c => c.id !== id); delete tasks[id]; renderKanban(); }

        // ===== „Ç´„É©„É†‰∏¶„Å≥Êõø„Åà =====
        let colOrderDragIdx = null;

        function openColumnOrderModal() {
            renderColumnOrderList();
            document.getElementById('columnOrderModal').classList.add('active');
        }

        function closeColumnOrderModal() {
            document.getElementById('columnOrderModal').classList.remove('active');
        }

        function renderColumnOrderList() {
            const body = document.getElementById('columnOrderBody');
            const canDelete = columns.length > 1; // ÊúÄ‰Ωé1„Å§„ÅØÊÆã„Åô
            
            body.innerHTML = columns.map((col, idx) => {
                const taskCount = (tasks[col.id] || []).length;
                
                return `
                <div class="column-order-item" 
                     draggable="true"
                     data-col-idx="${idx}"
                     ondragstart="colOrderDragStart(event, ${idx})"
                     ondragend="colOrderDragEnd(event)"
                     ondragover="colOrderDragOver(event, ${idx})"
                     ondragleave="colOrderDragLeave(event)"
                     ondrop="colOrderDrop(event, ${idx})">
                    <div class="column-order-info">
                        <div class="column-order-color" style="background:${col.color}"></div>
                        <div>
                            <div class="column-order-name">${col.title}</div>
                            <div class="column-order-count">${taskCount}‰ª∂</div>
                        </div>
                    </div>
                    <div class="column-order-actions">
                        <div class="column-order-arrows">
                            <button onclick="moveColumnUp(${idx})" ${idx === 0 ? 'disabled' : ''}>‚ñ≤</button>
                            <button onclick="moveColumnDown(${idx})" ${idx === columns.length - 1 ? 'disabled' : ''}>‚ñº</button>
                        </div>
                        <button class="column-order-del" 
                                onclick="confirmDeleteColumn('${col.id}', '${esc(col.title)}', ${taskCount})"
                                ${!canDelete ? 'disabled title="ÊúÄ‰Ωé1„Å§„ÅÆ„Ç´„É©„É†„ÅåÂøÖË¶Å„Åß„Åô"' : ''}>üóë</button>
                    </div>
                </div>
            `}).join('');
        }

        function moveColumnUp(idx) {
            if (idx <= 0) return;
            [columns[idx - 1], columns[idx]] = [columns[idx], columns[idx - 1]];
            save();
            renderColumnOrderList();
            renderKanban();
        }

        function moveColumnDown(idx) {
            if (idx >= columns.length - 1) return;
            [columns[idx], columns[idx + 1]] = [columns[idx + 1], columns[idx]];
            save();
            renderColumnOrderList();
            renderKanban();
        }

        function confirmDeleteColumn(colId, colTitle, taskCount) {
            // ÊúÄ‰Ωé1„Å§„ÅØÊÆã„Åô
            if (columns.length <= 1) return;
            
            let message = `„Äå${colTitle}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`;
            if (taskCount > 0) {
                message += `\n\n‚ö†Ô∏è ${taskCount}‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÇÇÂâäÈô§„Åï„Çå„Åæ„Åô`;
            }
            
            showConfirm('„Ç´„É©„É†„ÇíÂâäÈô§', message, 'ÂâäÈô§', 'danger', () => {
                columns = columns.filter(c => c.id !== colId);
                delete tasks[colId];
                save();
                renderColumnOrderList();
                renderKanban();
            });
        }

        function colOrderDragStart(e, idx) {
            colOrderDragIdx = idx;
            e.target.classList.add('dragging');
        }

        function colOrderDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.column-order-item').forEach(el => el.classList.remove('drag-over', 'dragging'));
            colOrderDragIdx = null;
        }

        function colOrderDragOver(e, idx) {
            e.preventDefault();
            if (colOrderDragIdx === null || colOrderDragIdx === idx) return;
            e.target.closest('.column-order-item')?.classList.add('drag-over');
        }

        function colOrderDragLeave(e) {
            e.target.closest('.column-order-item')?.classList.remove('drag-over');
        }

        function colOrderDrop(e, toIdx) {
            e.preventDefault();
            document.querySelectorAll('.column-order-item').forEach(el => el.classList.remove('drag-over'));
            
            if (colOrderDragIdx === null || colOrderDragIdx === toIdx) return;
            
            const col = columns.splice(colOrderDragIdx, 1)[0];
            columns.splice(toIdx, 0, col);
            save();
            renderColumnOrderList();
            renderKanban();
            colOrderDragIdx = null;
        }

        function openThemeModal() { renderPresets(); document.getElementById('coolorsInput').value = ''; document.getElementById('themeError').textContent = ''; document.getElementById('themeModal').classList.add('active'); }
        function closeThemeModal() { document.getElementById('themeModal').classList.remove('active'); }
        function renderPresets() {
            document.getElementById('presetGrid').innerHTML = PRESETS.map(p => `<button style="display:flex;flex-direction:column;align-items:center;gap:6px;padding:12px;border:2px solid #e5e7eb;border-radius:12px;background:white;cursor:pointer;" onclick="applyPreset('${p.name}')">
                <div style="display:flex;gap:4px;"><span style="width:20px;height:20px;border-radius:50%;background:${p.colors.primary}"></span><span style="width:20px;height:20px;border-radius:50%;background:${p.colors.secondary}"></span><span style="width:20px;height:20px;border-radius:50%;background:${p.colors.accent}"></span></div>
                <span style="font-size:12px;color:#666;">${p.name}</span></button>`).join('');
        }
        function applyPreset(name) { const p = PRESETS.find(x => x.name === name); if (p) { theme = {...p.colors}; updateColColors(); applyTheme(); renderKanban(); closeThemeModal(); } }
        function applyCoolors() {
            const url = document.getElementById('coolorsInput').value;
            const m = url.match(/coolors\.co\/([a-f0-9-]+)/i);
            if (m) {
                const cs = m[1].split('-').map(c => '#' + c);
                if (cs.length >= 3) { theme = { primary: cs[0], secondary: cs[1], accent: cs[cs.length-1], highlight: cs[2]||cs[0], bg: cs[3]||'#f2f5ff' }; updateColColors(); applyTheme(); renderKanban(); closeThemeModal(); return; }
            }
            document.getElementById('themeError').textContent = 'URL„ÇíËß£Êûê„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü';
        }
        function updateColColors() { columns = columns.map(c => c.id === 'todo' ? {...c, color: theme.primary} : c.id === 'doing' ? {...c, color: theme.secondary} : c.id === 'done' ? {...c, color: theme.accent} : c); }
        function applyTheme() {
            ['primary','secondary','accent','highlight','bg'].forEach(k => document.documentElement.style.setProperty('--color-' + k, theme[k]));
            document.body.style.background = `linear-gradient(135deg, ${theme.bg} 0%, #fff 100%)`;
            document.querySelector('meta[name="theme-color"]').content = theme.primary;
            save();
        }

        // ===== ÁøíÊÖ£ =====
        function genHabitDates() {
            const dates = [];
            let cur = new Date(START_DATE);
            while (cur <= END_DATE) { 
                dates.push(new Date(cur)); 
                cur.setDate(cur.getDate() + 1); 
            }
            return dates;
        }

        function renderHabitTable() {
            const container = document.getElementById('habitContainer');

            // ÁøíÊÖ£„Åå0‰ª∂„ÅÆÂ†¥Âêà
            if (habits.length === 0) {
                container.innerHTML = `
                    <div class="habit-empty">
                        <div class="habit-empty-icon">üìù</div>
                        <div class="habit-empty-text">„Åæ„Å†ÁøíÊÖ£„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>
                        <button class="habit-btn add" onclick="openHabitModal()">+ ÁøíÊÖ£„ÇíËøΩÂä†</button>
                    </div>
                `;
                return;
            }

            const dates = genHabitDates();

            let html = `
                <div class="habit-table-head">
                    <div class="habit-date-col">Êó•‰ªò</div>
                    <div class="habit-score-col-head">„Çπ„Ç≥„Ç¢</div>
                    <div class="habit-items-head" id="habitItemsHead">
                        ${habits.map((h, idx) => `
                            <div class="habit-item-col" 
                                 draggable="true" 
                                 data-habit-idx="${idx}"
                                 ondragstart="habitDragStart(event, ${idx})"
                                 ondragend="habitDragEnd(event)"
                                 ondragover="habitDragOver(event, ${idx})"
                                 ondragleave="habitDragLeave(event)"
                                 ondrop="habitDrop(event, ${idx})"
                                 ontouchstart="habitTouchStart(event, ${idx})"
                                 ontouchmove="habitTouchMove(event)"
                                 ontouchend="habitTouchEnd(event, ${idx})">
                                <div class="habit-emoji">${h.emoji}</div>
                                <div class="habit-name">${h.name}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="habit-table-body" id="habitBody" onscroll="syncHabitScroll()">
            `;

            let curMonth = -1;
            dates.forEach(d => {
                const ds = fmt(d), m = d.getMonth() + 1, today = isToday(d), wknd = isWknd(d);
                if (m !== curMonth) { curMonth = m; html += `<div class="habit-month-div month-bg-${m}">üìÖ ${d.getFullYear()}Âπ¥ ${m}Êúà</div>`; }
                
                // „Çπ„Ç≥„Ç¢„ÇíÂèñÂæó
                const scores = dailyScores[ds];
                let dayScore = 0, nightScore = 0;
                if (typeof scores === 'number') {
                    nightScore = scores;
                } else if (scores) {
                    dayScore = scores.day || 0;
                    nightScore = scores.night || 0;
                }
                
                html += `<div class="habit-row ${today ? 'today' : wknd ? 'weekend' : ''}" ${today ? 'id="todayRow"' : ''}>
                    <div class="habit-date-cell" onclick="openDiaryForDate('${ds}')" style="cursor:pointer;"><span class="day-name">${DAY_NAMES[d.getDay()]}</span><span class="date-num">${m}/${d.getDate()}</span>${today ? '<span class="today-badge">‰ªäÊó•</span>' : ''}</div>
                    <div class="habit-daily-scores" onclick="openDiaryForDate('${ds}')" style="cursor:pointer;">
                        <span class="daily-score night" style="background:${getScoreColor(nightScore)}">${nightScore || '-'}</span>
                        <span class="daily-score day" style="background:${getScoreColor(dayScore)}">${dayScore || '-'}</span>
                    </div>
                    <div class="habit-scores-cell" data-date="${ds}" onscroll="syncRowScroll(event)">${habits.map((h, idx) => {
                        const done = habitScores[ds]?.[h.id] ? true : false;
                        return `<div class="habit-score-cell" onclick="openDiaryForDateAndHabit('${ds}', ${idx})" style="cursor:pointer;"><div class="check-display ${done ? 'done' : ''}">${done ? '‚úì' : ''}</div></div>`;
                    }).join('')}</div>
                </div>`;
            });

            html += `</div>`;

            container.innerHTML = html;
            
            // „Çπ„ÇØ„É≠„Éº„É´ÂêåÊúü„ÅÆÂàùÊúüÂåñ
            setupHabitScrollSync();
        }
        
        // „Çπ„Ç≥„Ç¢„Å´Âøú„Åò„ÅüËâ≤„ÇíËøî„Åô
        function getScoreColor(score) {
            if (!score || score === 0) return '#f3f4f6';
            if (score >= 8) return '#86efac'; // Á∑ë
            if (score >= 5) return '#fef08a'; // ÈªÑ
            if (score >= 3) return '#fed7aa'; // „Ç™„É¨„É≥„Ç∏
            return '#fecaca'; // Ëµ§
        }
        
        // „Éò„ÉÉ„ÉÄ„Éº„Å®Êú¨‰Ωì„ÅÆ„Çπ„ÇØ„É≠„Éº„É´ÂêåÊúü
        function setupHabitScrollSync() {
            const header = document.getElementById('habitItemsHead');
            const body = document.getElementById('habitBody');
            if (!header || !body) return;
            
            // Êú¨‰Ωì„ÅÆÂêÑË°å„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„Çí„Éò„ÉÉ„ÉÄ„Éº„Å´ÂêåÊúü
            body.addEventListener('scroll', syncHabitScroll, { passive: true });
        }
        
        function syncHabitScroll() {
            const header = document.getElementById('habitItemsHead');
            const body = document.getElementById('habitBody');
            if (!header || !body) return;
            
            // ÊúÄÂàù„ÅÆË°å„ÅÆ„Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„ÇíÂèñÂæó
            const firstRow = body.querySelector('.habit-scores-cell');
            if (firstRow) {
                header.scrollLeft = firstRow.scrollLeft;
            }
        }
        
        // ÂêÑË°å„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÇíÂêåÊúü
        function syncRowScroll(e) {
            const scrollLeft = e.target.scrollLeft;
            const header = document.getElementById('habitItemsHead');
            if (header) header.scrollLeft = scrollLeft;
            
            // ‰ªñ„ÅÆË°å„ÇÇÂêåÊúü
            document.querySelectorAll('.habit-scores-cell').forEach(cell => {
                if (cell !== e.target) cell.scrollLeft = scrollLeft;
            });
        }

        // ===== ÁøíÊÖ£„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Éâ„É©„ÉÉ„Ç∞‰∏¶„Å≥Êõø„Åà =====
        let habitDragIdx = null;
        let habitTouchStartX = 0;
        let habitTouchElement = null;

        function habitDragStart(e, idx) {
            habitDragIdx = idx;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function habitDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.habit-item-col').forEach(el => {
                el.classList.remove('drag-over', 'dragging');
            });
            habitDragIdx = null;
        }

        function habitDragOver(e, idx) {
            e.preventDefault();
            if (habitDragIdx === null || habitDragIdx === idx) return;
            e.target.closest('.habit-item-col')?.classList.add('drag-over');
        }

        function habitDragLeave(e) {
            e.target.closest('.habit-item-col')?.classList.remove('drag-over');
        }

        function habitDrop(e, toIdx) {
            e.preventDefault();
            document.querySelectorAll('.habit-item-col').forEach(el => el.classList.remove('drag-over'));
            
            if (habitDragIdx === null || habitDragIdx === toIdx) return;
            
            // ‰∏¶„Å≥Êõø„ÅàÂÆüË°å
            reorderHabits(habitDragIdx, toIdx);
            habitDragIdx = null;
        }

        // „Çø„ÉÉ„ÉÅÊìç‰ΩúÁî®
        function habitTouchStart(e, idx) {
            habitDragIdx = idx;
            habitTouchStartX = e.touches[0].clientX;
            habitTouchElement = e.target.closest('.habit-item-col');
            
            // Èï∑Êäº„Åó„ÅßÈñãÂßã„ÇíÁ§∫„Åô
            setTimeout(() => {
                if (habitTouchElement) {
                    habitTouchElement.classList.add('dragging');
                    if (navigator.vibrate) navigator.vibrate(30);
                }
            }, 200);
        }

        function habitTouchMove(e) {
            if (habitDragIdx === null || !habitTouchElement) return;
            
            const touch = e.touches[0];
            const elements = document.elementsFromPoint(touch.clientX, touch.clientY);
            const targetCol = elements.find(el => el.classList.contains('habit-item-col') && el !== habitTouchElement);
            
            document.querySelectorAll('.habit-item-col').forEach(el => el.classList.remove('drag-over'));
            if (targetCol) {
                targetCol.classList.add('drag-over');
            }
        }

        function habitTouchEnd(e, fromIdx) {
            if (habitDragIdx === null) return;
            
            const touch = e.changedTouches[0];
            const elements = document.elementsFromPoint(touch.clientX, touch.clientY);
            const targetCol = elements.find(el => el.classList.contains('habit-item-col'));
            
            document.querySelectorAll('.habit-item-col').forEach(el => {
                el.classList.remove('drag-over', 'dragging');
            });
            
            if (targetCol && targetCol !== habitTouchElement) {
                const toIdx = parseInt(targetCol.dataset.habitIdx);
                if (!isNaN(toIdx) && fromIdx !== toIdx) {
                    reorderHabits(fromIdx, toIdx);
                }
            }
            
            habitDragIdx = null;
            habitTouchElement = null;
        }

        function reorderHabits(fromIdx, toIdx) {
            const habit = habits.splice(fromIdx, 1)[0];
            habits.splice(toIdx, 0, habit);
            save();
            renderHabitTable();
            
            // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function scrollToToday() {
            const row = document.getElementById('todayRow');
            const body = document.getElementById('habitBody');
            if (row && body) {
                requestAnimationFrame(() => {
                    // ‰ªäÊó•„ÅÆË°å„ÇíÁîªÈù¢‰∏≠Â§Æ„Çà„ÇäÂ∞ë„Åó‰∏ä„Å´Ë°®Á§∫
                    const bodyHeight = body.clientHeight;
                    const scrollPos = row.offsetTop - (bodyHeight / 3);
                    
                    body.scrollTo({
                        top: Math.max(0, scrollPos),
                        behavior: 'smooth'
                    });
                });
            }
        }

        // ===== Êó•Ë®ò„É¢„Éº„ÉÄ„É´ =====
        let diaryHabitIdx = 0; // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆÁøíÊÖ£„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
        let dailyScores = {}; // { "2025-12-01": { day: 10, night: 15 } } Êó•„Åî„Å®„ÅÆ„Çπ„Ç≥„Ç¢

        function openDiaryModal() {
            if (habits.length === 0) {
                alert('ÂÖà„Å´ÁøíÊÖ£„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            diaryDate = new Date();
            diaryHabitIdx = 0;
            renderDiaryModal();
            document.getElementById('diaryModal').classList.add('active');
        }

        function closeDiaryModal() {
            // Èñâ„Åò„ÇãÂâç„Å´ÁèæÂú®„ÅÆÂÇôËÄÉ„Çí‰øùÂ≠ò
            saveDiaryNote();
            save();
            
            // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„Çí‰øùÂ≠ò
            const habitBody = document.getElementById('habitBody');
            const scrollTop = habitBody ? habitBody.scrollTop : 0;
            
            renderHabitTable();
            
            // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„ÇíÂæ©ÂÖÉ
            const newHabitBody = document.getElementById('habitBody');
            if (newHabitBody) {
                newHabitBody.scrollTop = scrollTop;
            }
            
            document.getElementById('diaryModal').classList.remove('active');
        }

        function diaryPrevDay() {
            saveDiaryNote();
            save(); // ‰øùÂ≠ò„ÇíËøΩÂä†
            diaryDate.setDate(diaryDate.getDate() - 1);
            renderDiaryModal();
        }

        function diaryNextDay() {
            saveDiaryNote();
            save(); // ‰øùÂ≠ò„ÇíËøΩÂä†
            diaryDate.setDate(diaryDate.getDate() + 1);
            renderDiaryModal();
        }

        function diaryGoToday() {
            saveDiaryNote();
            save(); // ‰øùÂ≠ò„ÇíËøΩÂä†
            diaryDate = new Date();
            renderDiaryModal();
        }

        // ÁâπÂÆö„ÅÆÊó•‰ªò„ÅßÊó•Ë®ò„ÇíÈñã„Åè
        function openDiaryForDate(dateStr) {
            if (habits.length === 0) {
                alert('ÂÖà„Å´ÁøíÊÖ£„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            diaryDate = new Date(dateStr);
            diaryHabitIdx = 0;
            renderDiaryModal();
            document.getElementById('diaryModal').classList.add('active');
        }

        // ÁâπÂÆö„ÅÆÊó•‰ªò„Å®ÁøíÊÖ£„ÅßÊó•Ë®ò„ÇíÈñã„Åè
        function openDiaryForDateAndHabit(dateStr, habitIdx) {
            if (habits.length === 0) {
                alert('ÂÖà„Å´ÁøíÊÖ£„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            diaryDate = new Date(dateStr);
            diaryHabitIdx = habitIdx;
            renderDiaryModal();
            document.getElementById('diaryModal').classList.add('active');
        }

        function diaryPrevHabit() {
            saveDiaryNote();
            save(); // ‰øùÂ≠ò„ÇíËøΩÂä†
            diaryHabitIdx = (diaryHabitIdx - 1 + habits.length) % habits.length;
            renderDiaryModal();
        }

        function diaryNextHabit() {
            saveDiaryNote();
            save(); // ‰øùÂ≠ò„ÇíËøΩÂä†
            diaryHabitIdx = (diaryHabitIdx + 1) % habits.length;
            renderDiaryModal();
        }

        function selectDiaryHabit(idx) {
            saveDiaryNote();
            save(); // ‰øùÂ≠ò„ÇíËøΩÂä†
            diaryHabitIdx = idx;
            renderDiaryModal();
        }

        function renderDiaryModal() {
            const ds = fmt(diaryDate);
            const m = diaryDate.getMonth() + 1;
            const d = diaryDate.getDate();
            const dayName = DAY_NAMES[diaryDate.getDay()];
            
            document.getElementById('diaryDateLabel').textContent = `${diaryDate.getFullYear()}/${m}/${d}Ôºà${dayName}Ôºâ`;
            
            // Êòº„ÉªÂ§ú„ÅÆ„Çπ„Ç≥„Ç¢
            const scores = dailyScores[ds] || { day: 0, night: 0 };
            // ÂæåÊñπ‰∫íÊèõ: Êï∞ÂÄ§„Å†„Åë„ÅÆÂ†¥Âêà„ÅØnight„Å®„Åó„Å¶Êâ±„ÅÜ
            if (typeof scores === 'number') {
                document.getElementById('dayScoreInput').value = 0;
                document.getElementById('nightScoreInput').value = scores;
            } else {
                document.getElementById('dayScoreInput').value = scores.day || 0;
                document.getElementById('nightScoreInput').value = scores.night || 0;
            }
            
            // ÁøíÊÖ£„Çø„Éñ
            const tabsHtml = habits.map((h, idx) => {
                const note = habitNotes[ds]?.[h.id] || '';
                const hasNote = note.trim().length > 0;
                return `
                    <div class="diary-habit-tab ${idx === diaryHabitIdx ? 'active' : ''} ${hasNote ? 'has-note' : ''}" 
                         onclick="selectDiaryHabit(${idx})">
                        <span class="diary-tab-emoji">${h.emoji}</span>
                        <span class="diary-tab-name">${h.name}</span>
                        <span class="diary-tab-badge">${hasNote ? '‚úì' : '-'}</span>
                    </div>
                `;
            }).join('');
            document.getElementById('diaryHabitTabs').innerHTML = tabsHtml;
            
            // ÂÖ•Âäõ„Ç®„É™„Ç¢ÔºàÂÇôËÄÉ„ÅÆ„ÅøÔºâ
            const habit = habits[diaryHabitIdx];
            const note = habitNotes[ds]?.[habit.id] || '';
            
            const inputHtml = `
                <div class="diary-current-habit">
                    <div class="diary-current-emoji">${habit.emoji}</div>
                    <div class="diary-current-name">${habit.name}</div>
                </div>
                <label class="diary-note-label">üìù ‰ªäÊó•„ÅÆË®òÈå≤</label>
                <textarea class="diary-note-input" 
                          id="diaryNoteInput"
                          placeholder="‰ªäÊó•„ÅØ„Å©„ÅÜ„Åß„Åó„Åü„ÅãÔºü">${esc(note)}</textarea>
            `;
            document.getElementById('diaryInputArea').innerHTML = inputHtml;
            
            // ÈÅ∏Êäû‰∏≠„ÅÆ„Çø„Éñ„Å´„Çπ„ÇØ„É≠„Éº„É´
            setTimeout(() => {
                const activeTab = document.querySelector('.diary-habit-tab.active');
                if (activeTab) {
                    activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            }, 50);
        }

        function adjustDayScore(delta) {
            const input = document.getElementById('dayScoreInput');
            let value = parseInt(input.value) || 0;
            value = Math.max(0, Math.min(100, value + delta));
            input.value = value;
            saveDayScore();
        }

        function saveDayScore() {
            const ds = fmt(diaryDate);
            let value = parseInt(document.getElementById('dayScoreInput').value) || 0;
            value = Math.max(0, Math.min(100, value)); // 0-100„Å´Âà∂Èôê
            document.getElementById('dayScoreInput').value = value;
            if (!dailyScores[ds] || typeof dailyScores[ds] === 'number') {
                dailyScores[ds] = { day: 0, night: dailyScores[ds] || 0 };
            }
            dailyScores[ds].day = value;
            saveToLocal();
            apiCall('saveDailyScore', { date: ds, dayScore: dailyScores[ds].day, nightScore: dailyScores[ds].night });
        }

        function adjustNightScore(delta) {
            const input = document.getElementById('nightScoreInput');
            let value = parseInt(input.value) || 0;
            value = Math.max(0, Math.min(100, value + delta));
            input.value = value;
            saveNightScore();
        }

        function saveNightScore() {
            const ds = fmt(diaryDate);
            let value = parseInt(document.getElementById('nightScoreInput').value) || 0;
            value = Math.max(0, Math.min(100, value)); // 0-100„Å´Âà∂Èôê
            document.getElementById('nightScoreInput').value = value;
            if (!dailyScores[ds] || typeof dailyScores[ds] === 'number') {
                dailyScores[ds] = { day: 0, night: dailyScores[ds] || 0 };
            }
            dailyScores[ds].night = value;
            saveToLocal();
            apiCall('saveDailyScore', { date: ds, dayScore: dailyScores[ds].day, nightScore: dailyScores[ds].night });
        }

        function saveDiaryNote() {
            const textarea = document.getElementById('diaryNoteInput');
            if (!textarea || habits.length === 0) return;
            
            const ds = fmt(diaryDate);
            const habit = habits[diaryHabitIdx];
            const note = textarea.value;
            
            if (!habitNotes[ds]) habitNotes[ds] = {};
            habitNotes[ds][habit.id] = note;
            
            // ÂÇôËÄÉ„Åå„ÅÇ„Çå„Å∞„ÉÅ„Çß„ÉÉ„ÇØ„ÇÇÂÖ•„Çå„Çã
            if (!habitScores[ds]) habitScores[ds] = {};
            if (note.trim()) {
                habitScores[ds][habit.id] = 1;
            } else {
                habitScores[ds][habit.id] = 0;
            }
        }

        function setDiaryNote(habitId, note) {
            const ds = fmt(diaryDate);
            if (!habitNotes[ds]) habitNotes[ds] = {};
            habitNotes[ds][habitId] = note;
            
            // ÂÇôËÄÉ„Åå„ÅÇ„Çå„Å∞„ÉÅ„Çß„ÉÉ„ÇØ„ÇÇÂÖ•„Çå„Çã
            if (!habitScores[ds]) habitScores[ds] = {};
            if (note.trim()) {
                habitScores[ds][habitId] = 1;
            } else {
                habitScores[ds][habitId] = 0;
            }
            saveToLocal();
            apiCall('saveHabitNote', { date: ds, habitId: String(habitId), note: note });
            apiCall('saveHabitScore', { date: ds, habitId: String(habitId), score: habitScores[ds][habitId] });
        }

        // ÁøíÊÖ£„ÉÅ„Çß„ÉÉ„ÇØ„ÅÆ„Éà„Ç∞„É´
        function toggleHabitCheck(ds, habitId, cellId) {
            if (!habitScores[ds]) habitScores[ds] = {};
            
            // „Éà„Ç∞„É´: 1 ‚Üí 0, 0 ‚Üí 1
            const current = habitScores[ds][habitId] || 0;
            habitScores[ds][habitId] = current ? 0 : 1;
            
            // „É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü
            saveToLocal();
            apiCall('saveHabitScore', { date: ds, habitId: String(habitId), score: habitScores[ds][habitId] });
            
            // „Éú„Çø„É≥„Å†„ÅëÊõ¥Êñ∞ÔºàÂÖ®‰ΩìÂÜçÊèèÁîª„ÇíÈÅø„Åë„ÇãÔºâ
            const cell = document.getElementById(cellId);
            if (cell) {
                const btn = cell.querySelector('.check-btn');
                if (btn) {
                    const done = habitScores[ds][habitId];
                    btn.classList.toggle('done', done);
                    btn.textContent = done ? '‚úì' : '';
                }
            }
        }

        function openScoreModal(ds, hid, cur, cellId) {
            editScore = { ds, hid, cur, cellId };
            
            // ÈÅ∏Êäû‰∏≠„ÅÆ„Çª„É´„Çí„Éè„Ç§„É©„Ç§„Éà
            document.querySelectorAll('.habit-score-cell').forEach(c => c.classList.remove('editing'));
            const cell = document.getElementById(cellId);
            if (cell) cell.classList.add('editing');
            
            // ÁøíÊÖ£Âêç„ÇíÂèñÂæó
            const habit = habits.find(h => h.id === hid);
            const habitName = habit ? `${habit.emoji} ${habit.name}` : '';
            document.getElementById('scoreModalTitle').textContent = habitName ? `${habitName} „ÅÆ„Çπ„Ç≥„Ç¢` : '„Çπ„Ç≥„Ç¢„ÇíÈÅ∏Êäû';
            
            document.getElementById('scoreGrid').innerHTML = [0,1,2,3,4,5].map(s => `<button class="score-option ${s === cur ? 'selected' : ''}" style="background:${SCORE_COLORS[s]};color:${s >= 4 ? '#166534' : s >= 1 ? '#78350f' : '#9ca3af'};" onclick="setScore(${s})">${s || '‚úï'}</button>`).join('');
            document.getElementById('scoreModal').classList.add('active');
        }

        function closeScoreModal() { 
            document.getElementById('scoreModal').classList.remove('active'); 
            // „Éè„Ç§„É©„Ç§„ÉàËß£Èô§
            document.querySelectorAll('.habit-score-cell').forEach(c => c.classList.remove('editing'));
            editScore = null; 
        }

        function setScore(s) { 
            if (!editScore) return; 
            if (!habitScores[editScore.ds]) habitScores[editScore.ds] = {}; 
            habitScores[editScore.ds][editScore.hid] = s; 
            
            // „É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü
            saveHabitScore(editScore.ds, editScore.hid, s);
            
            save(); 
            renderHabitTable(); 
            closeScoreModal(); 
        }

        function openHabitModal() {
            selEmoji = '‚ú®'; document.getElementById('habitNameInput').value = '';
            document.getElementById('emojiGrid').innerHTML = ['‚ú®','üåÖ','üèÉ','üìö','üßò','üíß','ü•ó','üí™','üéØ','üí§','üö≠','üìù','üé®','üéµ','üíª','üå±'].map(e => `<button class="emoji-btn ${e === selEmoji ? 'selected' : ''}" onclick="selEmoji='${e}';document.querySelectorAll('#emojiGrid .emoji-btn').forEach(b=>b.classList.toggle('selected',b.textContent==='${e}'))">${e}</button>`).join('');
            document.getElementById('habitModal').classList.add('active');
        }
        function closeHabitModal() { document.getElementById('habitModal').classList.remove('active'); }
        function addHabit() { 
            const name = document.getElementById('habitNameInput').value.trim(); 
            if (!name) return; 
            const newHabit = { id: String(Date.now()), name, emoji: selEmoji };
            habits.push(newHabit); 
            saveToLocal();
            apiCall('addHabit', { habit: newHabit });
            renderHabitTable(); 
            closeHabitModal(); 
        }

        // ÁøíÊÖ£ÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´
        function openHabitManageModal() {
            renderHabitManageList();
            document.getElementById('habitManageModal').classList.add('active');
        }

        function closeHabitManageModal() {
            document.getElementById('habitManageModal').classList.remove('active');
        }

        function renderHabitManageList() {
            const body = document.getElementById('habitManageBody');
            if (habits.length === 0) {
                body.innerHTML = '<div style="text-align:center;padding:30px;color:#9ca3af;">ÁøíÊÖ£„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            body.innerHTML = habits.map(h => `
                <div class="habit-list-item">
                    <div class="habit-list-info">
                        <span class="habit-list-emoji">${h.emoji}</span>
                        <span class="habit-list-name">${h.name}</span>
                    </div>
                    <button class="habit-list-del" onclick="confirmDelHabit('${h.id}', '${esc(h.name)}')">ÂâäÈô§</button>
                </div>
            `).join('');
        }

        function confirmDelHabit(id, name) {
            showConfirm('ÁøíÊÖ£„ÇíÂâäÈô§', `„Äå${name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nË®òÈå≤„Éá„Éº„Çø„ÇÇÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ`, 'ÂâäÈô§', 'danger', () => {
                habits = habits.filter(h => String(h.id) !== String(id));
                saveToLocal();
                apiCall('deleteHabit', { habitId: String(id) });
                renderHabitTable();
                renderHabitManageList();
            });
        }

        // ===== Áµ±Ë®à =====
        let weeklyGoal = { day: 70, night: 70 }; // „Éá„Éï„Ç©„É´„ÉàÁõÆÊ®ô
        
        function openStatsModal() { 
            if (habits.length === 0) {
                showConfirm('„ÅäÁü•„Çâ„Åõ', 'ÁøíÊÖ£„ÇíÁôªÈå≤„Åó„Å¶„Åã„ÇâÈõÜË®à„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ', 'Èñâ„Åò„Çã', '', () => {});
                return;
            }
            // ÁõÆÊ®ô„ÇíLocalStorage„Åã„ÇâË™≠„ÅøËæº„Åø
            const savedGoal = localStorage.getItem('weekly_goal_v2');
            if (savedGoal) weeklyGoal = JSON.parse(savedGoal);
            
            statsTab = 'overview'; 
            renderStats(); 
            document.getElementById('statsModal').classList.add('active'); 
        }
        function closeStatsModal() { document.getElementById('statsModal').classList.remove('active'); }

        // ÈÄ±„ÅÆÈñãÂßãÊó•ÔºàÊúàÊõúÔºâ„ÇíÂèñÂæó
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        // „Çπ„Ç≥„Ç¢ÂèñÂæó„Éò„É´„Éë„Éº
        function getDayNightScores(ds) {
            const s = dailyScores[ds];
            if (!s) return { day: 0, night: 0 };
            if (typeof s === 'number') return { day: 0, night: s };
            return { day: s.day || 0, night: s.night || 0 };
        }

        // ÈÄ£Á∂öÈÅîÊàêÊó•Êï∞Ôºà„Çπ„Éà„É™„Éº„ÇØÔºâ„ÇíË®àÁÆó
        function calculateStreak() {
            const today = new Date();
            let streak = 0;
            let d = new Date(today);
            
            while (true) {
                const ds = fmt(d);
                const scores = getDayNightScores(ds);
                // Êòº„Åæ„Åü„ÅØÂ§ú„ÅÆ„Å©„Å°„Çâ„Åã„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Çå„Å∞„Ç´„Ç¶„É≥„Éà
                if (scores.day > 0 || scores.night > 0) {
                    streak++;
                    d.setDate(d.getDate() - 1);
                } else {
                    // ‰ªäÊó•„Åå„Åæ„Å†0„ÅÆÂ†¥Âêà„ÅØÊò®Êó•„Åã„ÇâÊï∞„Åà„Çã
                    if (streak === 0 && isToday(d)) {
                        d.setDate(d.getDate() - 1);
                        continue;
                    }
                    break;
                }
                if (d < START_DATE) break;
            }
            return streak;
        }

        // ÁøíÊÖ£„ÅÆ„Çπ„Éà„É™„Éº„ÇØË®àÁÆó
        function calculateHabitStreak(habitId) {
            const today = new Date();
            let streak = 0;
            let d = new Date(today);
            
            while (true) {
                const ds = fmt(d);
                const done = habitScores[ds]?.[habitId] ? true : false;
                if (done) {
                    streak++;
                    d.setDate(d.getDate() - 1);
                } else {
                    if (streak === 0 && isToday(d)) {
                        d.setDate(d.getDate() - 1);
                        continue;
                    }
                    break;
                }
                if (d < START_DATE) break;
            }
            return streak;
        }

        function renderStats() {
            const body = document.getElementById('statsBody');
            let html = `<div class="stats-tabs">
                <button class="stats-tab ${statsTab === 'overview' ? 'active' : ''}" onclick="statsTab='overview';renderStats()">üìä ÈÄ±Èñì</button>
                <button class="stats-tab ${statsTab === 'monthly' ? 'active' : ''}" onclick="statsTab='monthly';renderStats()">üìÖ ÊúàÂà•</button>
                <button class="stats-tab ${statsTab === 'graph' ? 'active' : ''}" onclick="statsTab='graph';renderStats()">üìà Êé®Áßª</button>
                <button class="stats-tab ${statsTab === 'goal' ? 'active' : ''}" onclick="statsTab='goal';renderStats()">üéØ ÁõÆÊ®ô</button>
            </div>`;

            if (statsTab === 'overview') {
                html += renderWeeklyOverview();
            } else if (statsTab === 'monthly') {
                html += renderMonthlyStats();
            } else if (statsTab === 'graph') {
                html += renderGraphStats();
            } else if (statsTab === 'goal') {
                html += renderGoalSettings();
            }

            body.innerHTML = html;
        }

        function renderWeeklyOverview() {
            const today = new Date();
            const weekStart = getWeekStart(today);
            let html = '';
            
            // „Çπ„Éà„É™„Éº„ÇØË°®Á§∫
            const streak = calculateStreak();
            const streakEmoji = streak >= 7 ? 'üî•' : streak >= 3 ? '‚≠ê' : 'üí™';
            html += `<div class="streak-banner">
                <div class="streak-emoji">${streakEmoji}</div>
                <div class="streak-info">
                    <div class="streak-label">ÈÄ£Á∂öË®òÈå≤Êó•Êï∞</div>
                    <div class="streak-value">${streak}<span>Êó•</span></div>
                </div>
            </div>`;
            
            // ‰ªäÈÄ±„ÅÆ„Çπ„Ç≥„Ç¢ÈõÜË®à
            // Êòº: ÂÖ•Âäõ„Åå„ÅÇ„ÇãÊó•„Å†„Åë„ÅßÂπ≥ÂùáÔºàÂúüÊó•Á•ù„Å™„Å©‰ºë„Åø„ÅÆÊó•„ÅØÈô§Â§ñÔºâ
            // Â§ú: ÂÖ®Êó•„ÅßÂπ≥Âùá
            let dayTotal = 0, nightTotal = 0, dayCount = 0, totalDays = 0;
            const weekData = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                if (d > today) break;
                totalDays++;
                const ds = fmt(d);
                const scores = getDayNightScores(ds);
                weekData.push({ date: d, day: scores.day, night: scores.night });
                if (scores.day > 0) { dayTotal += scores.day; dayCount++; }
                nightTotal += scores.night; // Â§ú„ÅØ0„Åß„ÇÇ„Ç´„Ç¶„É≥„Éà
            }
            
            const dayAvg = dayCount > 0 ? Math.round(dayTotal / dayCount) : 0;
            const nightAvg = totalDays > 0 ? Math.round(nightTotal / totalDays) : 0;
            const dayPct = Math.round((dayAvg / 100) * 100);
            const nightPct = Math.round((nightAvg / 100) * 100);
            
            // ÁõÆÊ®ôÈÅîÊàêÁéá
            const dayGoalPct = Math.min(100, Math.round((dayAvg / weeklyGoal.day) * 100));
            const nightGoalPct = Math.min(100, Math.round((nightAvg / weeklyGoal.night) * 100));
            
            html += `<div class="week-summary">
                <div class="week-score-card day">
                    <div class="week-score-label">‚òÄÔ∏è Êòº„ÅÆ‰ªï‰∫ã</div>
                    <div class="week-score-value">${dayAvg}<span>/100</span></div>
                    <div class="week-score-bar"><div class="week-score-fill" style="width:${dayPct}%;background:${getScoreColor(dayAvg)}"></div></div>
                    <div class="week-score-goal ${dayGoalPct >= 100 ? 'achieved' : ''}">ÁõÆÊ®ô${weeklyGoal.day}ÁÇπ: ${dayGoalPct}%ÈÅîÊàê</div>
                </div>
                <div class="week-score-card night">
                    <div class="week-score-label">üåô Â§ú„ÅÆ‰ªï‰∫ã</div>
                    <div class="week-score-value">${nightAvg}<span>/100</span></div>
                    <div class="week-score-bar"><div class="week-score-fill" style="width:${nightPct}%;background:${getScoreColor(nightAvg)}"></div></div>
                    <div class="week-score-goal ${nightGoalPct >= 100 ? 'achieved' : ''}">ÁõÆÊ®ô${weeklyGoal.night}ÁÇπ: ${nightGoalPct}%ÈÅîÊàê</div>
                </div>
            </div>`;
            
            // ‰ªäÈÄ±„ÅÆÊó•Âà•„Ç∞„É©„Éï
            html += `<h4 class="stats-section-title">üìä ‰ªäÈÄ±„ÅÆÊé®Áßª</h4>`;
            html += `<div class="week-chart">
                ${weekData.map((w, i) => {
                    const dayName = DAY_NAMES[w.date.getDay()];
                    const isTd = isToday(w.date);
                    return `<div class="week-chart-day ${isTd ? 'today' : ''}">
                        <div class="week-chart-bars">
                            <div class="week-chart-bar day" style="height:${Math.max(w.day, 2)}%;background:${getScoreColor(w.day)}"></div>
                            <div class="week-chart-bar night" style="height:${Math.max(w.night, 2)}%;background:${getScoreColor(w.night)}"></div>
                        </div>
                        <div class="week-chart-label">${dayName}</div>
                    </div>`;
                }).join('')}
            </div>`;
            
            // ÁøíÊÖ£ÈÅîÊàêÁéá
            html += `<h4 class="stats-section-title">‚úÖ ÁøíÊÖ£ÈÅîÊàêÁéáÔºà‰ªäÈÄ±Ôºâ</h4>`;
            const habitStats = habits.map(h => {
                let done = 0;
                for (let i = 0; i < 7; i++) {
                    const d = new Date(weekStart);
                    d.setDate(weekStart.getDate() + i);
                    if (d > today) break;
                    if (habitScores[fmt(d)]?.[h.id]) done++;
                }
                const streak = calculateHabitStreak(h.id);
                const pct = Math.round((done / Math.min(7, weekData.length)) * 100);
                return { ...h, done, pct, streak };
            });
            
            html += habitStats.map(h => `<div class="habit-stat-row">
                <div class="habit-stat-emoji">${h.emoji}</div>
                <div class="habit-stat-content">
                    <div class="habit-stat-name-row">
                        <span>${h.name}</span>
                        ${h.streak >= 3 ? `<span class="habit-streak-badge">üî•${h.streak}Êó•</span>` : ''}
                    </div>
                    <div class="habit-stat-bar"><div class="habit-stat-bar-fill" style="width:${h.pct}%;background:${h.pct >= 80 ? '#86efac' : h.pct >= 50 ? '#fef08a' : '#fecaca'};"></div></div>
                </div>
                <div class="habit-stat-pct">${h.pct}%</div>
            </div>`).join('');
            
            return html;
        }

        function renderMonthlyStats() {
            const { year, month } = statsMonth;
            const dim = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            let html = '';
            
            html += `<div class="month-selector">
                <button class="month-nav" onclick="statsMonth.month--;if(statsMonth.month<0){statsMonth.month=11;statsMonth.year--;}renderStats()">‚óÄ</button>
                <span class="month-label">${year}Âπ¥ ${month + 1}Êúà</span>
                <button class="month-nav" onclick="statsMonth.month++;if(statsMonth.month>11){statsMonth.month=0;statsMonth.year++;}renderStats()">‚ñ∂</button>
            </div>`;
            
            // ÊúàÈñì„Çπ„Ç≥„Ç¢ÈõÜË®à
            // Êòº: ÂÖ•Âäõ„Åå„ÅÇ„ÇãÊó•„Å†„Åë„ÅßÂπ≥Âùá
            // Â§ú: ÂÖ®Êó•„ÅßÂπ≥Âùá
            let dayTotal = 0, nightTotal = 0, dayCount = 0, totalDays = 0;
            for (let d = 1; d <= dim; d++) {
                const date = new Date(year, month, d);
                if (date > today || date < START_DATE) continue;
                totalDays++;
                const ds = fmt(date);
                const scores = getDayNightScores(ds);
                if (scores.day > 0) { dayTotal += scores.day; dayCount++; }
                nightTotal += scores.night; // Â§ú„ÅØ0„Åß„ÇÇ„Ç´„Ç¶„É≥„Éà
            }
            
            const dayAvg = dayCount > 0 ? Math.round(dayTotal / dayCount) : 0;
            const nightAvg = totalDays > 0 ? Math.round(nightTotal / totalDays) : 0;
            
            html += `<div class="month-summary">
                <div class="month-score-item">
                    <div class="month-score-label">‚òÄÔ∏è ÊòºÂπ≥Âùá</div>
                    <div class="month-score-value" style="background:${getScoreColor(dayAvg)}">${dayAvg}</div>
                    <div class="month-score-sub">${dayCount}Êó•Á®ºÂÉç</div>
                </div>
                <div class="month-score-item">
                    <div class="month-score-label">üåô Â§úÂπ≥Âùá</div>
                    <div class="month-score-value" style="background:${getScoreColor(nightAvg)}">${nightAvg}</div>
                    <div class="month-score-sub">${totalDays}Êó•‰∏≠</div>
                </div>
            </div>`;
            
            // ÁøíÊÖ£ÊúàÈñìÈÅîÊàêÁéá
            html += `<h4 class="stats-section-title">‚úÖ ÁøíÊÖ£ÈÅîÊàêÁéáÔºà${month + 1}ÊúàÔºâ</h4>`;
            let activeDays = 0;
            for (let d = 1; d <= dim; d++) {
                const date = new Date(year, month, d);
                if (date <= today && date >= START_DATE) activeDays++;
            }
            
            const hStats = habits.map(h => {
                let done = 0;
                for (let d = 1; d <= dim; d++) {
                    const date = new Date(year, month, d);
                    if (date > today || date < START_DATE) continue;
                    if (habitScores[fmt(date)]?.[h.id]) done++;
                }
                const pct = activeDays > 0 ? Math.round((done / activeDays) * 100) : 0;
                return { ...h, done, pct, total: activeDays };
            });
            
            html += hStats.map(h => `<div class="habit-stat-row">
                <div class="habit-stat-emoji">${h.emoji}</div>
                <div class="habit-stat-content">
                    <div class="habit-stat-name-row"><span>${h.name}</span></div>
                    <div class="habit-stat-bar"><div class="habit-stat-bar-fill" style="width:${h.pct}%;background:${h.pct >= 80 ? '#86efac' : h.pct >= 50 ? '#fef08a' : '#fecaca'};"></div></div>
                </div>
                <div class="habit-stat-detail">${h.done}/${h.total}Êó•<br>${h.pct}%</div>
            </div>`).join('');
            
            return html;
        }

        function renderGraphStats() {
            const today = new Date();
            let html = '';
            
            // ÈÅéÂéª4ÈÄ±Èñì„ÅÆ„Çπ„Ç≥„Ç¢Êé®Áßª
            html += `<h4 class="stats-section-title">üìà ÈÅéÂéª4ÈÄ±Èñì„ÅÆ„Çπ„Ç≥„Ç¢Êé®Áßª</h4>`;
            const weeksData = [];
            for (let w = 3; w >= 0; w--) {
                const weekEnd = new Date(today);
                weekEnd.setDate(today.getDate() - (w * 7));
                const weekStart = new Date(weekEnd);
                weekStart.setDate(weekEnd.getDate() - 6);
                
                let dayTotal = 0, nightTotal = 0, dayCount = 0, totalDays = 0;
                for (let i = 0; i < 7; i++) {
                    const d = new Date(weekStart);
                    d.setDate(weekStart.getDate() + i);
                    if (d > today || d < START_DATE) continue;
                    totalDays++;
                    const scores = getDayNightScores(fmt(d));
                    if (scores.day > 0) { dayTotal += scores.day; dayCount++; }
                    nightTotal += scores.night;
                }
                
                weeksData.push({
                    label: w === 0 ? '‰ªäÈÄ±' : `${w}ÈÄ±Ââç`,
                    dayAvg: dayCount > 0 ? Math.round(dayTotal / dayCount) : 0,
                    nightAvg: totalDays > 0 ? Math.round(nightTotal / totalDays) : 0
                });
            }
            
            html += `<div class="weeks-chart">
                ${weeksData.map(w => `<div class="weeks-chart-item">
                    <div class="weeks-chart-bars">
                        <div class="weeks-bar day" style="height:${w.dayAvg}%;background:${getScoreColor(w.dayAvg)}"><span>${w.dayAvg}</span></div>
                        <div class="weeks-bar night" style="height:${w.nightAvg}%;background:${getScoreColor(w.nightAvg)}"><span>${w.nightAvg}</span></div>
                    </div>
                    <div class="weeks-chart-label">${w.label}</div>
                </div>`).join('')}
            </div>
            <div class="chart-legend">
                <span class="legend-item"><span class="legend-dot day"></span>Êòº</span>
                <span class="legend-item"><span class="legend-dot night"></span>Â§ú</span>
            </div>`;
            
            // ÈÅéÂéª6„É∂Êúà„ÅÆÊé®Áßª
            html += `<h4 class="stats-section-title">üìä ÈÅéÂéª6„É∂Êúà„ÅÆÊé®Áßª</h4>`;
            const monthsData = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const yr = d.getFullYear(), mo = d.getMonth();
                const dim = new Date(yr, mo + 1, 0).getDate();
                let dayTotal = 0, nightTotal = 0, dayCount = 0, totalDays = 0;
                
                for (let day = 1; day <= dim; day++) {
                    const date = new Date(yr, mo, day);
                    if (date > today || date < START_DATE) continue;
                    totalDays++;
                    const scores = getDayNightScores(fmt(date));
                    if (scores.day > 0) { dayTotal += scores.day; dayCount++; }
                    nightTotal += scores.night;
                }
                
                monthsData.push({
                    label: `${mo + 1}Êúà`,
                    dayAvg: dayCount > 0 ? Math.round(dayTotal / dayCount) : 0,
                    nightAvg: totalDays > 0 ? Math.round(nightTotal / totalDays) : 0
                });
            }
            
            html += `<div class="months-chart">
                ${monthsData.map(m => `<div class="months-chart-item">
                    <div class="months-chart-bars">
                        <div class="months-bar day" style="height:${m.dayAvg}%;background:${getScoreColor(m.dayAvg)}"></div>
                        <div class="months-bar night" style="height:${m.nightAvg}%;background:${getScoreColor(m.nightAvg)}"></div>
                    </div>
                    <div class="months-chart-values">
                        <span class="day-val">${m.dayAvg}</span>
                        <span class="night-val">${m.nightAvg}</span>
                    </div>
                    <div class="months-chart-label">${m.label}</div>
                </div>`).join('')}
            </div>`;
            
            return html;
        }

        function renderGoalSettings() {
            let html = '';
            
            html += `<div class="goal-setting">
                <h4 class="stats-section-title">üéØ ÈÄ±ÈñìÁõÆÊ®ô„Çπ„Ç≥„Ç¢„ÅÆË®≠ÂÆö</h4>
                <p class="goal-desc">ÈÄ±„ÅÆÂπ≥Âùá„Çπ„Ç≥„Ç¢ÁõÆÊ®ô„ÇíË®≠ÂÆö„Åó„Å¶„ÄÅÈÅîÊàê„ÇíÁõÆÊåá„Åó„Åæ„Åó„Çá„ÅÜÔºÅ</p>
                
                <div class="goal-input-group">
                    <label class="goal-label">‚òÄÔ∏è Êòº„ÅÆ‰ªï‰∫ã ÁõÆÊ®ô</label>
                    <div class="goal-input-row">
                        <input type="range" min="10" max="100" step="5" value="${weeklyGoal.day}" 
                               onchange="weeklyGoal.day=parseInt(this.value);document.getElementById('dayGoalVal').textContent=this.value;saveGoal();">
                        <span class="goal-value" id="dayGoalVal">${weeklyGoal.day}</span>
                    </div>
                </div>
                
                <div class="goal-input-group">
                    <label class="goal-label">üåô Â§ú„ÅÆ‰ªï‰∫ã ÁõÆÊ®ô</label>
                    <div class="goal-input-row">
                        <input type="range" min="10" max="100" step="5" value="${weeklyGoal.night}" 
                               onchange="weeklyGoal.night=parseInt(this.value);document.getElementById('nightGoalVal').textContent=this.value;saveGoal();">
                        <span class="goal-value" id="nightGoalVal">${weeklyGoal.night}</span>
                    </div>
                </div>
            </div>`;
            
            // ÈÅîÊàê„Éê„ÉÉ„Ç∏
            const streak = calculateStreak();
            html += `<h4 class="stats-section-title">üèÜ ÈÅîÊàê„Éê„ÉÉ„Ç∏</h4>`;
            html += `<div class="badges-grid">
                <div class="badge-item ${streak >= 3 ? 'earned' : ''}">
                    <div class="badge-icon">üî•</div>
                    <div class="badge-name">3Êó•ÈÄ£Á∂ö</div>
                    ${streak >= 3 ? '<div class="badge-check">‚úì</div>' : ''}
                </div>
                <div class="badge-item ${streak >= 7 ? 'earned' : ''}">
                    <div class="badge-icon">‚≠ê</div>
                    <div class="badge-name">1ÈÄ±Èñì</div>
                    ${streak >= 7 ? '<div class="badge-check">‚úì</div>' : ''}
                </div>
                <div class="badge-item ${streak >= 14 ? 'earned' : ''}">
                    <div class="badge-icon">üåü</div>
                    <div class="badge-name">2ÈÄ±Èñì</div>
                    ${streak >= 14 ? '<div class="badge-check">‚úì</div>' : ''}
                </div>
                <div class="badge-item ${streak >= 30 ? 'earned' : ''}">
                    <div class="badge-icon">üëë</div>
                    <div class="badge-name">1„É∂Êúà</div>
                    ${streak >= 30 ? '<div class="badge-check">‚úì</div>' : ''}
                </div>
            </div>`;
            
            return html;
        }

        function saveGoal() {
            localStorage.setItem('weekly_goal_v2', JSON.stringify(weeklyGoal));
        }

        // ===== Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÄÄ =====
        function showConfirm(title, msg, btnTxt, btnClass, cb) { 
            document.getElementById('confirmTitle').textContent = title; 
            document.getElementById('confirmMsg').textContent = msg; 
            document.getElementById('confirmOk').textContent = btnTxt; 
            document.getElementById('confirmOk').className = 'confirm-btn ' + (btnClass || ''); 
            confirmCb = cb; 
            document.getElementById('confirmBack').classList.add('active'); 
            document.getElementById('confirmDlg').classList.add('active'); 
        }
        function closeConfirm() { document.getElementById('confirmBack').classList.remove('active'); document.getElementById('confirmDlg').classList.remove('active'); confirmCb = null; }
        function execConfirm() { if (confirmCb) confirmCb(); closeConfirm(); }
    </script>
</body>
</html>
